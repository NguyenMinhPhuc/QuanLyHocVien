(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[91],{3524:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/schedules",function(){return s(7803)}])},7803:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return SchedulesPage}});var a=s(5893),l=s(7294),c=s(6686),d=s(5951);function SchedulesPage(){let[e,t]=(0,l.useState)([]),[s,r]=(0,l.useState)(""),[n,i]=(0,l.useState)(1),[o,u]=(0,l.useState)(10),[h,m]=(0,l.useState)(0),[x,p]=(0,l.useState)("id"),[b,g]=(0,l.useState)("asc"),[y,f]=(0,l.useState)([]),[w,k]=(0,l.useState)(""),[j,N]=(0,l.useState)(""),[_,v]=(0,l.useState)(!1),[S,T]=(0,l.useState)(null),[C,E]=(0,l.useState)(!1),[D,A]=(0,l.useState)(!1),[H,L]=(0,l.useState)(null),[O,U]=(0,l.useState)(1),[I,M]=(0,l.useState)({id:null,class_id:"",weekday:0,start_time:"08:00",end_time:"09:30"}),P=[(0,d.t)("schedules.weekday.0","Chủ nhật"),(0,d.t)("schedules.weekday.1","Thứ 2"),(0,d.t)("schedules.weekday.2","Thứ 3"),(0,d.t)("schedules.weekday.3","Thứ 4"),(0,d.t)("schedules.weekday.4","Thứ 5"),(0,d.t)("schedules.weekday.5","Thứ 6"),(0,d.t)("schedules.weekday.6","Thứ 7")];function dbWeekdayToIndex(e){if(null==e||""===e)return null;let t=Number(e);if(isNaN(t))return null;let s=t-1;return s>=0&&s<=6?s:null}function indexToDbWeekday(e){let t=Number(e);return isNaN(t)?null:t+1}async function load(){v(!0);try{let e=new URLSearchParams;s&&e.set("q",s),j&&e.set("classId",j),e.set("page",n),e.set("pageSize",o),x&&e.set("sortField",x),b&&e.set("sortDir",b);let[a,l]=await Promise.all([(0,c.SH)("/api/schedules?"+e.toString()),(0,c.SH)("/api/classes")]);if(!a.ok)throw Error("Failed to load schedules");let d=await a.json(),r=d&&d.rows?d.rows:d;if(t(r||[]),m(d&&d.total?Number(d.total):0),l.ok){let e=await l.json();Array.isArray(e)||(e=e&&Array.isArray(e.rows)?e.rows:e&&Array.isArray(e.items)?e.items:[]),f(e||[])}else f([])}catch(e){T(e.message)}finally{v(!1)}}function formatTime(e){if(!e)return"";try{if(e instanceof Date){let t=e.getFullYear(),s=t<=1970?e.getUTCHours():e.getHours(),a=t<=1970?e.getUTCMinutes():e.getMinutes();return"".concat(String(s).padStart(2,"0"),":").concat(String(a).padStart(2,"0"))}let t=String(e);if(t.includes("T")){let e=new Date(t);if(!isNaN(e.getTime()))return e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}let s=t.split(":");if(s.length>=2)return"".concat(s[0].padStart(2,"0"),":").concat(s[1].padStart(2,"0"));return t.slice(0,5)}catch(t){return e}}function parseTimeForInput(e){if(!e)return"";try{if(e instanceof Date){let t=e.getFullYear(),s=t<=1970?e.getUTCHours():e.getHours(),a=t<=1970?e.getUTCMinutes():e.getMinutes();return"".concat(String(s).padStart(2,"0"),":").concat(String(a).padStart(2,"0"))}let t=String(e);if(t.includes("T")){let e=new Date(t);if(!isNaN(e.getTime())){let t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return"".concat(t,":").concat(s)}}let s=t.split(":");if(s.length>=2)return"".concat(s[0].padStart(2,"0"),":").concat(s[1].padStart(2,"0"));return t.slice(0,5)}catch(e){return""}}async function submit(e){e.preventDefault();try{let e;if(!I.schedule_date){T((0,d.t)("schedules.error.date_required","Vui l\xf2ng chọn ng\xe0y"));return}let t={class_id:Number(I.class_id),start_time:I.start_time,end_time:I.end_time,schedule_date:I.schedule_date};if(Array.isArray(I.weekdays)&&I.weekdays.length>0?t.weekdays=I.weekdays.map(e=>indexToDbWeekday(e)):t.weekday=indexToDbWeekday(I.weekday),!(e=I.id?await (0,c.SH)("/api/schedules/".concat(I.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}):await (0,c.SH)("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}))||!e.ok){let t="";try{t=await e.text()}catch(e){t=String(e)}console.error("[schedules.submit] non-ok response",e&&e.status,t);let s=(()=>{try{return JSON.parse(t)}catch(e){return null}})();throw Error(s&&s.error?s.error:"Server error: ".concat(e&&e.status," ").concat(t))}E(!1),await load()}catch(e){T(e.message)}}async function remove(e){if(window.confirm((0,d.t)("class_students.confirm_delete","X\xe1c nhận x\xf3a?")))try{let t=await (0,c.SH)("/api/schedules/".concat(e),{method:"DELETE"});if(!t||!t.ok){let e="";try{e=await t.text()}catch(t){e=String(t)}throw console.error("[schedules.remove] delete failed",t&&t.status,e),Error("Delete failed: ".concat(t&&t.status))}await load()}catch(e){T(e.message)}}return(0,l.useEffect)(()=>{load()},[]),(0,l.useEffect)(()=>{load()},[s,n,o,x,b,j]),(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold",children:(0,d.t)("schedules.title","Quản l\xfd lịch")}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("div",{className:"relative w-full max-w-xs",children:[(0,a.jsx)("input",{placeholder:(0,d.t)("schedules.search.placeholder","T\xecm kiếm..."),value:s,onChange:e=>{r(e.target.value),i(1)},className:"p-2 pr-8 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"}),s&&(0,a.jsx)("button",{onClick:()=>{r(""),i(1)},className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700",children:"\xd7"})]}),(0,a.jsxs)("select",{value:j,onChange:e=>{N(e.target.value),i(1)},className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,a.jsx)("option",{value:"",children:(0,d.t)("schedules.filter.all_classes","-- Tất cả lớp --")}),(y||[]).map(e=>(0,a.jsx)("option",{value:e.id,children:e.course_name||e.name||"Class ".concat(e.id)},e.id))]}),(0,a.jsxs)("select",{value:o,onChange:e=>{u(Number(e.target.value)),i(1)},className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,a.jsx)("option",{value:5,children:"5"}),(0,a.jsx)("option",{value:10,children:"10"}),(0,a.jsx)("option",{value:20,children:"20"}),(0,a.jsx)("option",{value:50,children:"50"})]}),(0,a.jsx)("button",{onClick:function(){M({id:null,class_id:"",weekdays:[],weekday:0,schedule_date:"",start_time:"08:00",end_time:"09:30"}),E(!0)},className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,d.t)("schedules.create","Tạo lịch")}),(0,a.jsxs)("select",{value:w,onChange:e=>k(e.target.value),className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,a.jsx)("option",{value:"",children:(0,d.t)("schedules.export.all","Tất cả lớp")}),(y||[]).map(e=>(0,a.jsx)("option",{value:e.id,children:e.course_name||e.name||"Class ".concat(e.id)},e.id))]}),(0,a.jsx)("button",{onClick:async()=>{try{let e=new URLSearchParams;w&&e.set("classId",w);let t=await (0,c.SH)("/api/schedules/export.ics"+(e.toString()?"?"+e.toString():""));if(!t.ok)throw Error("Export failed");let s=await t.blob(),a=window.URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download="schedules.ics",document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(a)}catch(e){T(e.message)}},className:"px-3 py-2 border rounded",children:(0,d.t)("schedules.export_button","Export .ics")})]})]}),S&&(0,a.jsx)("div",{className:"text-red-600 mb-2",children:S}),(0,a.jsx)("div",{className:"bg-white dark:bg-slate-800 dark:text-slate-100 p-4 rounded",children:_?(0,a.jsx)("div",{children:(0,d.t)("actions.loading","Đang tải...")}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("table",{className:"min-w-full table-auto",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"text-left",children:[(0,a.jsx)("th",{className:"p-2",children:(0,d.t)("debts.table.no","STT")}),(0,a.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{p("class_id"),g("class_id"===x&&"asc"===b?"desc":"asc")},children:(0,d.t)("schedules.col.class","Lớp")}),(0,a.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{p("schedule_date"),g("schedule_date"===x&&"asc"===b?"desc":"asc")},children:(0,d.t)("schedules.col.date","Ng\xe0y")}),(0,a.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{p("weekday"),g("weekday"===x&&"asc"===b?"desc":"asc")},children:(0,d.t)("schedules.col.weekday","Thứ")}),(0,a.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{p("start_time"),g("start_time"===x&&"asc"===b?"desc":"asc")},children:(0,d.t)("schedules.col.start","Bắt đầu")}),(0,a.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{p("end_time"),g("end_time"===x&&"asc"===b?"desc":"asc")},children:(0,d.t)("schedules.col.end","Kết th\xfac")}),(0,a.jsx)("th",{children:(0,d.t)("actions.actions","Thao t\xe1c")})]})}),(0,a.jsx)("tbody",{children:(e||[]).map((e,t)=>{let s=e&&(e.schedule_date||e.date)?new Date(e.schedule_date||e.date).toLocaleDateString():"-",l=null;void 0!==e.weekday&&null!==e.weekday?l=dbWeekdayToIndex(e.weekday):e.schedule_date&&(l=new Date(e.schedule_date).getDay());let c=null!=l?P[l]:"-";return(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"p-2",children:t+1}),(0,a.jsxs)("td",{className:"p-2",children:[(0,a.jsx)("div",{children:function(e){let t=(y||[]).find(t=>Number(t.id)===Number(e));return t?t.course_name||t.name||t.course||"Class ".concat(e):e}(e.class_id)}),(0,a.jsxs)("div",{className:"text-sm text-slate-500",children:[e.teacher_name||"",e.teacher_phone?" • ".concat(e.teacher_phone):""]})]}),(0,a.jsx)("td",{className:"p-2",children:s}),(0,a.jsx)("td",{className:"p-2",children:c}),(0,a.jsx)("td",{className:"p-2",children:formatTime(e.start_time)}),(0,a.jsx)("td",{className:"p-2",children:formatTime(e.end_time)}),(0,a.jsxs)("td",{className:"p-2",children:[(0,a.jsx)("button",{onClick:()=>{M({id:e.id,class_id:e.class_id,weekdays:Array.isArray(e.weekdays)?e.weekdays.map(dbWeekdayToIndex).filter(e=>null!==e):void 0!==e.weekday&&null!==e.weekday?[dbWeekdayToIndex(e.weekday)]:[],weekday:dbWeekdayToIndex(e.weekday),schedule_date:function(e){if(!e)return"";try{let t=String(e);if(t.includes("T"))return t.split("T")[0];if(t.match(/\d{4}-\d{2}-\d{2}/))return t.match(/\d{4}-\d{2}-\d{2}/)[0];let s=new Date(t);if(!isNaN(s.getTime()))return"".concat(s.getFullYear(),"-").concat(String(s.getMonth()+1).padStart(2,"0"),"-").concat(String(s.getDate()).padStart(2,"0"))}catch(e){}return""}(e.schedule_date||e.date||e.schedule_date),start_time:parseTimeForInput(e.start_time),end_time:parseTimeForInput(e.end_time)}),E(!0)},className:"mr-2 px-2 py-1 bg-yellow-500 text-white rounded",children:(0,d.t)("actions.edit","Sửa")}),(0,a.jsx)("button",{onClick:()=>remove(e.id),className:"mr-2 px-2 py-1 bg-red-600 text-white rounded",children:(0,d.t)("actions.delete","X\xf3a")}),(0,a.jsx)("button",{onClick:()=>{L(e),U(1),A(!0)},className:"px-2 py-1 bg-blue-600 text-white rounded",children:(0,d.t)("schedules.copy","Sao ch\xe9p")})]})]},e.id)})})]}),(0,a.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"text-sm",children:[(0,d.t)("schedules.pagination.total","Tổng"),": ",h]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>i(1),disabled:n<=1,className:"px-2 py-1 border rounded",children:(0,d.t)("pagination.first","Đầu")}),(0,a.jsx)("button",{onClick:()=>i(e=>Math.max(1,e-1)),disabled:n<=1,className:"px-2 py-1 border rounded",children:(0,d.t)("pagination.prev","Trước")}),(0,a.jsx)("div",{className:"px-2",children:n}),(0,a.jsx)("button",{onClick:()=>i(e=>e+1),disabled:n*o>=h,className:"px-2 py-1 border rounded",children:(0,d.t)("pagination.next","Sau")}),(0,a.jsx)("button",{onClick:()=>i(Math.max(1,Math.ceil(h/o))),disabled:n*o>=h,className:"px-2 py-1 border rounded",children:(0,d.t)("pagination.last","Cuối")})]})]})]})}),C&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>E(!1)}),(0,a.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:I.id?(0,d.t)("schedules.edit_title","Sửa lịch"):(0,d.t)("schedules.create_title","Tạo lịch")}),(0,a.jsxs)("form",{onSubmit:submit,className:"grid gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.form.class","Lớp")}),(0,a.jsxs)("select",{value:I.class_id,onChange:e=>M(t=>({...t,class_id:e.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,a.jsx)("option",{value:"",children:(0,d.t)("schedules.form.select_class","-- Chọn lớp --")}),(y||[]).map(e=>(0,a.jsx)("option",{value:e.id,children:e.course_name||e.name||e.course||"Class ".concat(e.id)},e.id))]}),0===(y||[]).length&&(0,a.jsx)("div",{className:"text-sm text-slate-500 mt-1",children:(0,d.t)("schedules.no_classes","Chưa c\xf3 lớp n\xe0o. Vui l\xf2ng tạo lớp trước khi th\xeam lịch.")})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.form.weekdays","Chọn ng\xe0y lặp lại")}),(0,a.jsx)("div",{className:"grid grid-cols-4 gap-2",children:P.map((e,t)=>(0,a.jsxs)("label",{className:"flex items-center gap-2",children:[(0,a.jsx)("input",{type:"checkbox",checked:Array.isArray(I.weekdays)?I.weekdays.includes(t):Number(I.weekday)===t,onChange:e=>{let s=e.target.checked;M(e=>{let a=Array.isArray(e.weekdays)?[...e.weekdays]:[e.weekday];if(s)a.includes(t)||a.push(t);else{let e=a.indexOf(t);-1!==e&&a.splice(e,1)}return{...e,weekdays:a}})}}),(0,a.jsx)("span",{className:"text-sm",children:e})]},t))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.form.specific_date","Ng\xe0y cụ thể (t\xf9y chọn)")}),(0,a.jsx)("input",{required:!0,type:"date",value:I.schedule_date||"",onChange:e=>M(t=>({...t,schedule_date:e.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"}),(0,a.jsx)("div",{className:"text-xs text-slate-500 mt-1",children:(0,d.t)("schedules.form.specific_date_help","Nếu đặt ng\xe0y, lịch n\xe0y sẽ l\xe0 buổi cụ thể thay v\xec lặp theo thứ")})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.form.start_time","Bắt đầu")}),(0,a.jsx)("input",{type:"time",value:I.start_time,onChange:e=>M(t=>({...t,start_time:e.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.form.end_time","Kết th\xfac")}),(0,a.jsx)("input",{type:"time",value:I.end_time,onChange:e=>M(t=>({...t,end_time:e.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>E(!1),className:"px-3 py-2 border rounded",children:(0,d.t)("actions.cancel","Hủy")}),(0,a.jsx)("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,d.t)("actions.confirm","Lưu")})]})]})]})]}),D&&H&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>A(!1)}),(0,a.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-sm z-60",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:(0,d.t)("schedules.copy_title","Sao ch\xe9p lịch")}),(0,a.jsx)("div",{className:"mb-2",children:(0,d.t)("schedules.copy_help","Chọn số buổi sẽ được tạo tiếp theo h\xe0ng tuần")}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,d.t)("schedules.copy.count","Số buổi")}),(0,a.jsx)("input",{type:"number",min:1,value:O,onChange:e=>U(Math.max(1,Number(e.target.value||1))),className:"p-2 border rounded w-full"})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>A(!1),className:"px-3 py-2 border rounded",children:(0,d.t)("actions.cancel","Hủy")}),(0,a.jsx)("button",{type:"button",onClick:async()=>{try{let e=await (0,c.SH)("/api/schedules/".concat(H.id,"/copy"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({count:O})});if(!e.ok){let t="";try{t=await e.text()}catch(e){t=e.message}throw Error(t||"Copy failed")}A(!1),await load()}catch(e){T(e.message)}},className:"px-3 py-2 bg-blue-600 text-white rounded",children:(0,d.t)("schedules.copy_confirm","Sao ch\xe9p")})]})]})]})]})]})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=3524)}),_N_E=e.O()}]);