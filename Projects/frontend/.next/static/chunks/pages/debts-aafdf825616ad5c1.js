(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[669],{6943:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/debts",function(){return a(8550)}])},7871:function(e,t,a){"use strict";function sanitizeNumericInput(e){if(null==e)return"";let t=String(e);t=t.replace(/[^0-9.]/g,"");let a=t.split(".");return a.length>2&&(t=a[0]+"."+a.slice(1).join("")),t}function formatWithThousands(e){if(null==e||""===e)return"";let t=String(e).replace(/,/g,"");if(t.indexOf(".")>=0){let[e,a]=t.split("."),s=Number(e||0).toLocaleString();return a?"".concat(s,".").concat(a):"".concat(s,".")}return Number(t).toLocaleString()}a.d(t,{U:function(){return formatWithThousands},x:function(){return sanitizeNumericInput}})},8550:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return DebtsPage}});var s=a(5893),n=a(7294),l=a(6686),i=a(7871),r=a(7219),d=a(5951);function qs(e){let t=encodeURIComponent;return Object.keys(e).filter(t=>void 0!==e[t]&&null!==e[t]&&""!==e[t]).map(a=>"".concat(t(a),"=").concat(t(e[a]))).join("&")}function DebtsPage(){let[e,t]=(0,n.useState)([]),[a,c]=(0,n.useState)(""),[o,h]=(0,n.useState)("total_outstanding"),[u,x]=(0,n.useState)("DESC"),[p,m]=(0,n.useState)(1),[b,g]=(0,n.useState)(20),[j,f]=(0,n.useState)(0),[N,S]=(0,n.useState)(""),[w,v]=(0,n.useState)(""),[k,y]=(0,n.useState)("any"),[C,_]=(0,n.useState)(!1),[E,D]=(0,n.useState)(null),[O,T]=(0,n.useState)(!1),[A,L]=(0,n.useState)(null),[P,z]=(0,n.useState)(""),[H,M]=(0,n.useState)("cash"),[R,F]=(0,n.useState)(!1),[J,q]=(0,n.useState)(""),[X,I]=(0,n.useState)(!1),[Q,U]=(0,n.useState)([]),[K,W]=(0,n.useState)(!1);async function load(){_(!0);try{let e={q:a||void 0,sortField:o,sortDir:u,minOutstanding:N||void 0,maxOutstanding:w||void 0,hasDebt:"with"===k||"without"!==k&&void 0,page:p,pageSize:b},s="/api/students/debts"+(qs(e)?"?".concat(qs(e)):""),n=await (0,l.SH)(s);if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.error||"Failed to load")}let i=await n.json();t(i.rows||[]),f(i.total||0),m(i.page||p),g(i.pageSize||b)}catch(e){D(e.message)}finally{_(!1)}}async function submitEdit(e){if(e.preventDefault(),A)try{let e=Number(String(J||""));if(isNaN(e)||e<0)return D("Gi\xe1 trị kh\xf4ng hợp lệ");let t=await (0,l.SH)("/api/students/".concat(A.id,"/debt"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({outstanding:e})}),a=await parseResponse(t);if(!t.ok){let e="object"==typeof a?a.error||JSON.stringify(a):a||"Failed";throw Error(e)}F(!1),await load()}catch(e){D(e.message)}}async function deleteDebt(e){if(confirm("X\xe1c nhận x\xf3a c\xf4ng nợ của ".concat(e.name||"","?")))try{let t=await (0,l.SH)("/api/students/".concat(e.id,"/debt"),{method:"DELETE"}),a=await parseResponse(t);if(!t.ok){let e="object"==typeof a?a.error||JSON.stringify(a):a||"Failed";throw Error(e)}await load()}catch(e){D(e.message)}}async function openStudentClasses(e){L(e),U([]),I(!0),W(!0);try{let t=await (0,l.SH)("/api/students/".concat(e.id,"/enrollments"));if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed to load enrollments")}let a=await t.json();U(a||[])}catch(e){D(e.message)}finally{W(!1)}}async function submitPay(e){if(e.preventDefault(),A)try{let e=Number(String(P||""));if(!e||e<=0)return D("Số tiền kh\xf4ng hợp lệ");let t=await (0,l.SH)("/api/students/".concat(A.id,"/pay"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,method:H})}),a=await parseResponse(t);if(!t.ok){let e="object"==typeof a?a.error||JSON.stringify(a):a||"Failed";throw Error(e)}T(!1),await load()}catch(e){D(e.message)}}async function parseResponse(e){let t=e&&e.headers&&e.headers.get&&e.headers.get("content-type")||"";try{if(t.includes("application/json"))return await e.json();let a=await e.text();return a}catch(t){try{return await e.text()}catch(e){return null}}}return(0,n.useEffect)(()=>{load()},[a,o,u,p,b,N,w,k]),(0,s.jsxs)("div",{className:"p-4",children:[(0,s.jsxs)("div",{className:"mb-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:(0,d.t)("debts.title","Quản l\xfd c\xf4ng nợ")}),(0,s.jsx)("div",{className:"mt-3 bg-white dark:bg-slate-800 p-3 rounded",children:(0,s.jsxs)("div",{className:"flex gap-2 items-center flex-wrap",children:[(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("input",{placeholder:(0,d.t)("debts.search.placeholder","T\xecm kiếm t\xean hoặc sđt"),value:a,onChange:e=>{c(e.target.value),m(1)},className:"p-2 pr-8 border rounded bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"}),a&&(0,s.jsx)("button",{onClick:()=>{c(""),m(1)},className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700",children:"\xd7"})]}),(0,s.jsx)("input",{placeholder:(0,d.t)("debts.minOutstanding","Min nợ"),value:N,onChange:e=>{S(e.target.value),m(1)},className:"p-2 border rounded w-36 bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"}),(0,s.jsx)("input",{placeholder:(0,d.t)("debts.maxOutstanding","Max nợ"),value:w,onChange:e=>{v(e.target.value),m(1)},className:"p-2 border rounded w-36 bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"}),(0,s.jsxs)("select",{value:k,onChange:e=>{y(e.target.value),m(1)},className:"p-2 border rounded bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600",children:[(0,s.jsx)("option",{value:"any",children:(0,d.t)("debts.filter.any","Tất cả")}),(0,s.jsx)("option",{value:"with",children:(0,d.t)("debts.filter.with","C\xf3 nợ")}),(0,s.jsx)("option",{value:"without",children:(0,d.t)("debts.filter.without","Kh\xf4ng nợ")})]}),(0,s.jsxs)("select",{value:b,onChange:e=>{g(Number(e.target.value)),m(1)},className:"p-2 border rounded bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600",children:[(0,s.jsx)("option",{value:10,children:"10"}),(0,s.jsx)("option",{value:20,children:"20"}),(0,s.jsx)("option",{value:50,children:"50"})]})]})})]}),E&&(0,s.jsx)("div",{className:"text-red-600 mb-2",children:E}),(0,s.jsx)("div",{className:"bg-white dark:bg-slate-800 p-4 rounded",children:C?(0,s.jsx)("div",{children:"Loading..."}):(0,s.jsxs)("table",{className:"min-w-full table-auto",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"No."}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"name"===o?x("ASC"===u?"DESC":"ASC"):(h("name"),x("ASC"))},children:(0,d.t)("debts.table.name","Họ t\xean")}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"phone"===o?x("ASC"===u?"DESC":"ASC"):(h("phone"),x("ASC"))},children:(0,d.t)("debts.table.phone","SĐT")}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"classes_active"===o?x("ASC"===u?"DESC":"ASC"):(h("classes_active"),x("DESC"))},children:(0,d.t)("debts.table.active","Lớp đang học")}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"classes_finished"===o?x("ASC"===u?"DESC":"ASC"):(h("classes_finished"),x("DESC"))},children:(0,d.t)("debts.table.finished","Lớp đ\xe3 kết th\xfac")}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"total_outstanding"===o?x("ASC"===u?"DESC":"ASC"):(h("total_outstanding"),x("DESC"))},children:(0,d.t)("debts.table.total_owed","Tổng nợ")}),(0,s.jsx)("th",{className:"p-2 cursor-pointer",onClick:()=>{"total_paid"===o?x("ASC"===u?"DESC":"ASC"):(h("total_paid"),x("DESC"))},children:(0,d.t)("debts.table.total_paid","Đ\xe3 thanh to\xe1n")}),(0,s.jsx)("th",{className:"p-2",children:(0,d.t)("debts.table.remaining","C\xf2n lại")}),(0,s.jsx)("th",{className:"p-2",children:(0,d.t)("debts.table.parent","Phụ huynh")}),(0,s.jsx)("th",{className:"p-2",children:(0,d.t)("debts.table.actions","H\xe0nh động")})]})}),(0,s.jsx)("tbody",{children:e.map((e,t)=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2",children:(p-1)*b+t+1}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("button",{onClick:()=>openStudentClasses(e),className:"text-left text-blue-600 dark:text-blue-300 underline",children:e.name})}),(0,s.jsx)("td",{className:"p-2",children:e.phone||"—"}),(0,s.jsx)("td",{className:"p-2",children:e.classes_active}),(0,s.jsx)("td",{className:"p-2",children:e.classes_finished}),(0,s.jsx)("td",{className:"p-2",children:Number(e.total_outstanding||0).toLocaleString()}),(0,s.jsx)("td",{className:"p-2",children:Number(e.total_paid||0).toLocaleString()}),(0,s.jsx)("td",{className:"p-2",children:Number((e.total_outstanding||0)-(e.total_paid||0)).toLocaleString()}),(0,s.jsxs)("td",{className:"p-2",children:[e.parent_name||"",e.parent_phone?" (".concat(e.parent_phone,")"):""]}),(0,s.jsxs)("td",{className:"p-2 flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>{L(e),z(""),M("cash"),T(!0)},title:(0,d.t)("debts.actions.pay","Thanh to\xe1n"),className:"p-2 rounded bg-green-600 text-white hover:opacity-90",children:(0,s.jsx)(r.oQC,{})}),(0,s.jsx)("button",{onClick:()=>{L(e),q(String(Number(e.total_outstanding||0))),F(!0)},title:"Sửa c\xf4ng nợ",className:"p-2 rounded bg-yellow-500 text-white hover:opacity-90",children:(0,s.jsx)(r.vPQ,{})}),(0,s.jsx)("button",{onClick:()=>deleteDebt(e),title:"X\xf3a c\xf4ng nợ",className:"p-2 rounded bg-red-600 text-white hover:opacity-90",children:(0,s.jsx)(r.Ybf,{})})]})]},e.id))})]})}),(0,s.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,s.jsxs)("div",{children:["Showing ",(p-1)*b+1," - ",Math.min(p*b,j)," of ",j]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{disabled:p<=1,onClick:()=>m(e=>Math.max(1,e-1)),className:"px-3 py-1 border rounded",children:"Prev"}),(0,s.jsx)("span",{className:"px-3 py-1",children:p}),(0,s.jsx)("button",{disabled:p*b>=j,onClick:()=>m(e=>e+1),className:"px-3 py-1 border rounded",children:"Next"})]})]}),O&&A&&(0,s.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>T(!1)}),(0,s.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,s.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:["Thanh to\xe1n — ",A.name]}),(0,s.jsxs)("form",{onSubmit:submitPay,className:"grid gap-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm",children:"Amount"}),(0,s.jsx)("input",{type:"text",inputMode:"decimal",value:P,onChange:e=>z((0,i.x)(e.target.value)),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm",children:"Method"}),(0,s.jsxs)("select",{value:H,onChange:e=>M(e.target.value),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600",children:[(0,s.jsx)("option",{value:"cash",children:"Tiền mặt"}),(0,s.jsx)("option",{value:"transfer",children:"Chuyển khoản"})]})]}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)("button",{type:"button",onClick:()=>T(!1),className:"px-3 py-2 border rounded",children:"Cancel"}),(0,s.jsx)("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:"Pay"})]})]})]})]}),R&&A&&(0,s.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>F(!1)}),(0,s.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,s.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:["Sửa c\xf4ng nợ — ",A.name]}),(0,s.jsxs)("form",{onSubmit:submitEdit,className:"grid gap-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm",children:"Outstanding"}),(0,s.jsx)("input",{type:"text",inputMode:"decimal",value:J,onChange:e=>q((0,i.x)(e.target.value)),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"})]}),(0,s.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,s.jsx)("button",{type:"button",onClick:()=>F(!1),className:"px-3 py-2 border rounded",children:"Cancel"}),(0,s.jsx)("button",{type:"submit",className:"px-3 py-2 bg-yellow-500 text-white rounded",children:"Save"})]})]})]})]}),X&&A&&(0,s.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>I(!1)}),(0,s.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-2xl z-60",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,s.jsxs)("h3",{className:"text-lg font-semibold",children:["Lớp đang tham gia — ",A.name]}),(0,s.jsx)("button",{onClick:()=>I(!1),className:"px-2 py-1 border rounded",children:"Đ\xf3ng"})]}),K?(0,s.jsx)("div",{children:"Loading..."}):(0,s.jsxs)("table",{className:"min-w-full table-auto",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-2 text-left",children:"Class"}),(0,s.jsx)("th",{className:"p-2",children:"Reg date"}),(0,s.jsx)("th",{className:"p-2",children:"Status"}),(0,s.jsx)("th",{className:"p-2",children:"Outstanding"}),(0,s.jsx)("th",{className:"p-2",children:"Paid"})]})}),(0,s.jsxs)("tbody",{children:[0===Q.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:5,className:"p-2",children:"Kh\xf4ng c\xf3 lớp"})}),Q.map(e=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2",children:e.class_name||e.class_id}),(0,s.jsx)("td",{className:"p-2",children:e.registration_date?new Date(e.registration_date).toLocaleDateString():"—"}),(0,s.jsx)("td",{className:"p-2",children:e.status}),(0,s.jsx)("td",{className:"p-2",children:Number(e.outstanding_balance||0).toLocaleString()}),(0,s.jsx)("td",{className:"p-2",children:Number(e.total_paid||0).toLocaleString()})]},e.id))]})]})]})]})]})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=6943)}),_N_E=e.O()}]);