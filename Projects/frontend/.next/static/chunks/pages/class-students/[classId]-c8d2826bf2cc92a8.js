(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[475],{2594:function(t,e,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/class-students/[classId]",function(){return s(2529)}])},7871:function(t,e,s){"use strict";function sanitizeNumericInput(t){if(null==t)return"";let e=String(t);e=e.replace(/[^0-9.]/g,"");let s=e.split(".");return s.length>2&&(e=s[0]+"."+s.slice(1).join("")),e}function formatWithThousands(t){if(null==t||""===t)return"";let e=String(t).replace(/,/g,"");if(e.indexOf(".")>=0){let[t,s]=e.split("."),a=Number(t||0).toLocaleString();return s?"".concat(a,".").concat(s):"".concat(a,".")}return Number(e).toLocaleString()}s.d(e,{U:function(){return formatWithThousands},x:function(){return sanitizeNumericInput}})},2529:function(t,e,s){"use strict";s.r(e),s.d(e,{default:function(){return ClassStudentsPage}});var a=s(5893),n=s(7294),i=s(7871),l=s(1163),r=s(6686),c=s(5951);function ClassStudentsPage(){let t=(0,l.useRouter)(),{classId:e}=t.query,[s,d]=(0,n.useState)([]),[o,u]=(0,n.useState)(null),[h,m]=(0,n.useState)(!1),[x,p]=(0,n.useState)(null),[g,b]=(0,n.useState)(!1),[f,_]=(0,n.useState)(null),[v,j]=(0,n.useState)(""),[y,w]=(0,n.useState)("cash"),[N,k]=(0,n.useState)([]),[S,C]=(0,n.useState)(!1),[T,H]=(0,n.useState)(""),[L,E]=(0,n.useState)([]),[P,O]=(0,n.useState)(""),[D,z]=(0,n.useState)(!1),[I,K]=(0,n.useState)(!1),[B,J]=(0,n.useState)({status:"",assigned_teacher_id:"",registration_date:""});async function load(){if(e){m(!0);try{let t=await (0,r.SH)("/api/classes/".concat(e,"/enrollments"));if(!t.ok)throw Error((0,c.t)("class_students.error.load_enrollments","Kh\xf4ng tải được danh s\xe1ch học vi\xean"));let s=await t.json();d(s);try{let t=await (0,r.SH)("/api/classes/".concat(e));if(t.ok){let e=await t.json();u(e)}}catch(t){console.warn((0,c.t)("class_students.warn.load_class_info","Kh\xf4ng tải được th\xf4ng tin lớp"),t)}}catch(t){p(t.message)}finally{m(!1)}}}async function loadPayments(t){try{let e=await (0,r.SH)("/api/enrollments/".concat(t,"/payments"));if(!e.ok)return;k(await e.json())}catch(t){}}async function submitPayment(t){if(t.preventDefault(),f)try{let t=Number(String(v||"").replace(/,/g,""));if(!t||t<=0)return p((0,c.t)("pay.invalid_amount","Số tiền kh\xf4ng hợp lệ"));let e=await (0,r.SH)("/api/enrollments/".concat(f.id,"/payments"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:t,method:y})}),s=await e.json();if(!e.ok)throw Error(s.error||(0,c.t)("class_students.error.add_payment","Kh\xf4ng thể th\xeam khoản thu"));if(j(""),w("cash"),await loadPayments(f.id),await load(),s&&s.receipt&&s.receipt.id)try{let t=await (0,r.SH)("/api/receipts/".concat(s.receipt.id)),e=null;t.ok&&(e=await t.json());let a=e&&e.receipt?e.receipt:s.receipt,n=e&&e.details?e.details:(()=>{try{return JSON.parse(a.data)}catch(t){return{}}})(),i=e&&e.settings?e.settings:{},l=Object.keys(n||{}).filter(t=>!["student_name","student_phone","class_name","amount","method","note"].includes(t)).map(t=>'<div class="row"><div>'.concat(t.replace(/_/g," "),"</div><div>").concat(n[t]||"","</div></div>")).join(""),c='<!doctype html><html><head><meta charset="utf-8"><title>Phiếu '.concat(a.receipt_number,'</title><style>body{font-family: Arial, Helvetica, sans-serif;padding:16px;font-size:12px} .container{width:420px;margin:0 auto} h1{font-size:16px;text-align:center} .row{display:flex;justify-content:space-between;margin:6px 0} .bold{font-weight:700}</style></head><body><div class="container">').concat(i&&i.receipt_logo_url?'<div style="text-align:center;margin-bottom:6px"><img src="'.concat(i.receipt_logo_url,'" style="max-height:60px"/></div>'):"",'<h1>PHIẾU THU</h1><div class="row"><div>Phiếu số:</div><div class="bold">').concat(a.receipt_number,'</div></div><div class="row"><div>Ng\xe0y:</div><div class="bold">').concat(new Date(a.created_at).toLocaleString(),'</div></div><hr><div class="row"><div>Học sinh:</div><div>').concat(n&&n.student_name?n.student_name:"",'</div></div><div class="row"><div>SDT học sinh:</div><div>').concat(n&&n.student_phone?n.student_phone:"",'</div></div><div class="row"><div>Lớp / Kh\xf3a:</div><div>').concat(n&&n.class_name?n.class_name:"",'</div></div><div class="row"><div>Số tiền:</div><div class="bold">').concat(Number(n&&n.amount||0).toLocaleString(),' đ</div></div><div class="row"><div>H\xecnh thức:</div><div>').concat(n&&n.method||"","</div></div>").concat(l).concat(i&&i.receipt_center_phone?'<div class="row"><div>Điện thoại:</div><div>'.concat(i.receipt_center_phone,"</div></div>"):"",'<div style="margin-top:20px">Người thu: ____________________</div><div style="margin-top:40px;font-size:11px;color:#666">Ghi ch\xfa: ').concat(n&&n.note?n.note:"","</div></div></body></html>"),d=window.open("","_blank","width=600,height=800");d.document.write(c),d.document.close(),setTimeout(()=>{try{d.print()}catch(t){console.warn("print failed",t)}},500)}catch(t){console.error("Failed to open receipt",t)}}catch(t){p(t.message)}}function openTransfer(t){_(t),(async()=>{try{let e=[];if("reserved"===String(t.status||"").toLowerCase()){let t=await (0,r.SH)("/api/classes/active");t.ok&&(e=await t.json()),console.log("[openTransfer] candidates (all active) from server",e&&e.length)}else{let s=await (0,r.SH)("/api/classes/".concat(t.class_id));if(!s.ok){p("Kh\xf4ng lấy được th\xf4ng tin lớp nguồn"),C(!0);return}let a=await s.json();console.log("[openTransfer] classInfo",a);let n=a.course_id;if(n){let t=await (0,r.SH)("/api/classes/course/".concat(n,"/active"));t.ok&&(e=await t.json()),console.log("[openTransfer] candidates (same course) from server",e&&e.length)}else console.log("[openTransfer] no courseId, cannot fetch candidates")}E(e||[]),H("")}catch(t){console.error("openTransfer error",t),p("Lỗi khi tải danh s\xe1ch lớp chuyển")}finally{C(!0)}})()}async function submitTransfer(){if(f){if(!T)return p((0,c.t)("class_students.transfer.error.pick_target","Vui l\xf2ng chọn lớp đ\xedch"));try{let t=await (0,r.SH)("/api/enrollments/".concat(f.id,"/transfer"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_class_id:Number(T)})});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed")}C(!1),H(""),await load()}catch(t){p(t.message)}}}async function holdEnrollmentAction(t){if(t&&t.id)try{let e=window.prompt("L\xfd do bảo lưu (t\xf9y chọn):","")||"",s=await (0,r.SH)("/api/enrollments/".concat(t.id,"/hold"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"hold",reason:e})}),a=await s.json().catch(()=>({}));if(!s.ok)throw Error(a.error||"Kh\xf4ng thể bảo lưu");await load()}catch(t){p(t.message)}}async function assignBackToClass(t){t&&openTransfer(t)}async function submitEdit(t){if(t.preventDefault(),f)try{let t={...B};if(t.registration_date&&""!==String(t.registration_date).trim())try{t.registration_date=new Date(t.registration_date).toISOString()}catch(t){}else t.registration_date=null;let e=await (0,r.SH)("/api/enrollments/".concat(f.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await e.json();if(!e.ok)throw Error(s.error||"Failed");K(!1),await load()}catch(t){p(t.message)}}async function addEnrollment(){t.push("/classes")}return(0,n.useEffect)(()=>{load()},[e]),(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("h1",{className:"text-2xl font-semibold",children:[(0,c.t)("class_students.title","Học vi\xean trong")," ",o&&(o.course_name||o.name)||"Class ".concat(e)]}),(0,a.jsx)("div",{children:(0,a.jsx)("button",{onClick:addEnrollment,className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,c.t)("class_students.enroll","Ghi danh học vi\xean")})})]}),x&&(0,a.jsx)("div",{className:"text-red-600 mb-2",children:x}),(0,a.jsx)("div",{className:"bg-white dark:bg-slate-800 dark:text-slate-100 p-4 rounded",children:h?(0,a.jsx)("div",{children:(0,c.t)("actions.loading","Đang tải...")}):(0,a.jsxs)("table",{className:"min-w-full table-auto",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"text-left",children:[(0,a.jsx)("th",{className:"p-2",children:(0,c.t)("debts.table.no","STT")}),(0,a.jsx)("th",{children:(0,c.t)("debts.table.name","Họ t\xean")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.col.reg_date","Ng\xe0y đăng k\xfd")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.col.status","Trạng th\xe1i")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.col.debt_paid","Nợ / Đ\xe3 trả")}),(0,a.jsx)("th",{children:(0,c.t)("actions.actions","Thao t\xe1c")})]})}),(0,a.jsx)("tbody",{children:s.map((t,e)=>(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"p-2",children:e+1}),(0,a.jsx)("td",{className:"p-2",children:t.student_name}),(0,a.jsx)("td",{className:"p-2",children:t.registration_date||"—"}),(0,a.jsx)("td",{className:"p-2",children:t.status}),(0,a.jsxs)("td",{className:"p-2",children:[(0,a.jsxs)("div",{className:"text-sm text-slate-700 dark:text-slate-200 mb-1",children:["Nợ: ",(0,a.jsx)("strong",{children:null!=t.outstanding_balance?Number(t.outstanding_balance).toLocaleString():"—"})]}),(0,a.jsxs)("div",{className:"text-sm text-slate-500 dark:text-slate-400",children:["Đ\xe3 trả: ",(0,a.jsx)("strong",{children:Number(t.total_paid||0).toLocaleString()})]})]}),(0,a.jsxs)("td",{className:"p-2",children:[(0,a.jsx)("button",{onClick:()=>(function(t){_(t);try{let e=t&&null!=t.outstanding_balance?String(Number(t.outstanding_balance)):"";j((0,i.x)(e))}catch(t){j("")}b(!0),loadPayments(t.id)})(t),className:"mr-2 px-2 py-1 bg-blue-500 text-white rounded",children:(0,c.t)("class_students.btn.payments","Thu tiền")}),(0,a.jsx)("button",{onClick:()=>(function(t){_(t);let e="";if(t&&t.registration_date)try{let s=new Date(t.registration_date);isNaN(s.getTime())||(e=s.toISOString().slice(0,10))}catch(t){e=""}J({status:t.status||"",assigned_teacher_id:t.assigned_teacher_id||"",registration_date:e}),K(!0)})(t),className:"mr-2 px-2 py-1 bg-yellow-500 text-white rounded",children:(0,c.t)("class_students.btn.edit","Chỉnh sửa")}),(0,a.jsx)("button",{onClick:()=>openTransfer(t),className:"mr-2 px-2 py-1 bg-indigo-600 text-white rounded",children:(0,c.t)("class_students.btn.transfer","Chuyển lớp")}),"reserved"!==String(t.status||"").toLowerCase()?(0,a.jsx)("button",{onClick:()=>holdEnrollmentAction(t),className:"ml-2 px-2 py-1 bg-gray-600 text-white rounded",children:"Bảo lưu"}):(0,a.jsx)("button",{onClick:()=>assignBackToClass(t),className:"ml-2 px-2 py-1 bg-green-600 text-white rounded",children:"G\xe1n lại"})]})]},t.id))})]})}),g&&f&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>b(!1)}),(0,a.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-lg z-60",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,c.t)("class_students.payments.title","Thu tiền")," — ",f.student_name]}),(0,a.jsxs)("div",{className:"mb-3 text-sm text-slate-700 dark:text-slate-200",children:[(0,c.t)("class_students.payments.outstanding","Số tiền nợ hiện tại"),": ",(0,a.jsx)("strong",{children:null!=f.outstanding_balance?Number(f.outstanding_balance).toLocaleString():"—"})]}),(0,a.jsx)("div",{className:"mb-3",children:(0,a.jsxs)("form",{onSubmit:submitPayment,className:"grid grid-cols-1 gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,c.t)("class_students.payments.amount","Số tiền")}),(0,a.jsx)("input",{type:"text",inputMode:"decimal",value:(0,i.U)(v),onChange:t=>j((0,i.x)(t.target.value)),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,c.t)("class_students.payments.method","H\xecnh thức")}),(0,a.jsxs)("select",{value:y,onChange:t=>w(t.target.value),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600",children:[(0,a.jsx)("option",{value:"cash",children:"Tiền mặt"}),(0,a.jsx)("option",{value:"transfer",children:"Chuyển khoản"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>b(!1),className:"px-3 py-2 border rounded",children:(0,c.t)("actions.cancel","Hủy")}),(0,a.jsx)("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,c.t)("class_students.payments.add","Th\xeam khoản thu")})]})]})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold mb-2",children:(0,c.t)("class_students.payments.history","Lịch sử")}),(0,a.jsxs)("table",{className:"min-w-full table-auto",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{children:(0,c.t)("class_students.payments.col.paid_at","Thời gian")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.payments.col.amount","Số tiền")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.payments.col.method","H\xecnh thức")}),(0,a.jsx)("th",{children:(0,c.t)("class_students.payments.col.note","Ghi ch\xfa")})]})}),(0,a.jsx)("tbody",{children:N.map(t=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:new Date(t.paid_at).toLocaleString()}),(0,a.jsx)("td",{children:Number(t.amount).toLocaleString()}),(0,a.jsx)("td",{children:t.method}),(0,a.jsx)("td",{children:t.note})]},t.id))})]})]})]})]}),S&&f&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>C(!1)}),(0,a.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,c.t)("class_students.transfer.title","Chuyển lớp")," — ",f.student_name]}),(0,a.jsxs)("div",{className:"grid gap-2",children:[(0,a.jsx)("label",{className:"block text-sm font-medium",children:"reserved"===String((null==f?void 0:f.status)||"").toLowerCase()?(0,c.t)("class_students.transfer.label.active","Chọn lớp đ\xedch (lớp đang hoạt động)"):(0,c.t)("class_students.transfer.label.same_course","Chọn lớp đ\xedch (c\xf9ng kh\xf3a, chưa kết th\xfac)")}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{placeholder:(0,c.t)("class_students.transfer.search_placeholder","T\xecm lớp..."),value:P,onChange:t=>{O(t.target.value),z(!0),H("")},onFocus:()=>z(!0),className:"p-2 pr-8 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"}),P&&(0,a.jsx)("button",{type:"button",onClick:()=>{O(""),H("")},className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700",children:"\xd7"}),(0,a.jsxs)("div",{className:"absolute left-0 right-0 mt-1 bg-white dark:bg-slate-800 dark:border-slate-700 border rounded max-h-56 overflow-auto z-40 ".concat(D?"":"hidden"),children:[(L||[]).filter(t=>{let e=(P||"").toLowerCase().trim(),s="".concat(t.course_name||t.name||"Class "+t.id," ").concat(t.teacher_name||t.teacher||"").toLowerCase();return!e||s.includes(e)}).map(t=>{let e="#".concat(t.id," — ").concat(t.course_name||t.name||"Class "+t.id," — ").concat(t.teacher_name||t.teacher||"TBA");return(0,a.jsxs)("div",{onMouseDown:()=>{H(String(t.id)),O(e),z(!1)},className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:[(0,a.jsx)("div",{className:"font-medium",children:e}),(0,a.jsxs)("div",{className:"text-sm text-slate-500",children:[t.course_start_date?new Date(t.course_start_date).toLocaleDateString():"start?"," → ",t.course_end_date?new Date(t.course_end_date).toLocaleDateString():"ongoing"]})]},t.id)}),0===(L||[]).filter(t=>{let e=(P||"").toLowerCase().trim(),s="".concat(t.id," ").concat(t.course_name||t.course_id).toLowerCase();return!e||s.includes(e)}).length&&(0,a.jsx)("div",{className:"p-2 text-sm text-slate-500",children:(0,c.t)("class_students.transfer.none","Kh\xf4ng t\xecm thấy lớp")})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{onClick:()=>C(!1),className:"px-3 py-2 border rounded",children:(0,c.t)("actions.cancel","Hủy")}),(0,a.jsx)("button",{onClick:submitTransfer,className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,c.t)("class_students.transfer.submit","Chuyển lớp")})]})]})]})]}),I&&f&&(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>K(!1)}),(0,a.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,c.t)("class_students.edit.title","Chỉnh sửa ghi danh")," — ",f.student_name]}),(0,a.jsxs)("form",{onSubmit:submitEdit,className:"grid gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,c.t)("class_students.edit.status","Trạng th\xe1i")}),(0,a.jsxs)("select",{value:B.status,onChange:t=>J(e=>({...e,status:t.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600",children:[(0,a.jsx)("option",{value:"active",children:(0,c.t)("class_students.status.active","K\xedch hoạt")}),(0,a.jsx)("option",{value:"reserved",children:(0,c.t)("class_students.status.reserved","Bảo lưu")}),(0,a.jsx)("option",{value:"withdrawn",children:(0,c.t)("class_students.status.withdrawn","R\xfat")})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,c.t)("class_students.edit.registration_date","Ng\xe0y đăng k\xfd")}),(0,a.jsx)("input",{type:"date",value:B.registration_date||"",onChange:t=>J(e=>({...e,registration_date:t.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm",children:(0,c.t)("class_students.edit.assigned_teacher_id","ID gi\xe1o vi\xean")}),(0,a.jsx)("input",{value:B.assigned_teacher_id||"",onChange:t=>J(e=>({...e,assigned_teacher_id:t.target.value})),className:"p-2 border rounded w-full bg-white dark:bg-slate-700 dark:text-slate-100 dark:border-slate-600"})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>K(!1),className:"px-3 py-2 border rounded",children:(0,c.t)("actions.cancel","Hủy")}),(0,a.jsx)("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,c.t)("actions.confirm","Lưu")})]})]})]})]})]})}}},function(t){t.O(0,[774,888,179],function(){return t(t.s=2594)}),_N_E=t.O()}]);