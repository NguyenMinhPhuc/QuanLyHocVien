(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[166],{4490:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/attendance",function(){return a(4436)}])},4436:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return AttendancePage}});var s=a(5893),n=a(7294),l=a(6686),c=a(7219);function AttendancePage(){let[e,t]=(0,n.useState)([]),[a,r]=(0,n.useState)(!1),[d,i]=(0,n.useState)(null),[o,u]=(0,n.useState)(""),[h,x]=(0,n.useState)("name"),[m,p]=(0,n.useState)("asc"),[j,g]=(0,n.useState)(1),[b,f]=(0,n.useState)(10),[N,v]=(0,n.useState)(!1),[w,y]=(0,n.useState)(null),[S,C]=(0,n.useState)(()=>new Date().toISOString().slice(0,10)),[_,k]=(0,n.useState)([]),[A,L]=(0,n.useState)(!1);async function loadMyClasses(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:S;r(!0);try{let a=new URLSearchParams;e&&a.set("date",e);let s=await (0,l.SH)("/api/attendance/my-classes"+(a.toString()?"?".concat(a.toString()):""));if(!s.ok){let e="";try{e=await s.json()}catch(t){e=await s.text().catch(()=>"")}throw Error("Failed to load classes (status ".concat(s.status,") ").concat("string"==typeof e?e:JSON.stringify(e)))}let n=await s.json();t(n||[])}catch(e){i(e.message||String(e))}finally{r(!1)}}async function openAttendanceModal(e){i(null),y(e),v(!0),await loadStudentsForClass(e.id,S)}async function loadStudentsForClass(e,t){r(!0);try{let a=await (0,l.SH)("/api/attendance/class/".concat(e,"/students?date=").concat(t));if(!a.ok){let e="";try{e=await a.json()}catch(t){e=await a.text().catch(()=>"")}throw Error("Failed to load students (status ".concat(a.status,") ").concat("string"==typeof e?e:JSON.stringify(e)))}let s=await a.json(),n=(s.students||[]).map(e=>({student_id:e.student_id,name:e.name,phone:e.phone,status:e.attendance&&e.attendance.status||"absent",checkin_time:e.attendance&&e.attendance.checkin_time||null}));k(n)}catch(e){i(e.message||String(e))}finally{r(!1)}}(0,n.useEffect)(()=>{loadMyClasses()},[]),(0,n.useEffect)(()=>{g(1)},[o,h,m,b]);let totalPages=()=>{let t=Array.isArray(e)?e.filter(e=>{if(!o)return!0;let t=o.toLowerCase();return(e.name||"").toLowerCase().includes(t)||(e.course_name||"").toLowerCase().includes(t)}):[];return Math.max(1,Math.ceil(t.length/b))};async function saveAttendance(){if(w){L(!0);try{let e=_.map(e=>({student_id:e.student_id,status:e.status,checkin_time:e.checkin_time})),t=await (0,l.SH)("/api/attendance/class/".concat(w.id,"/records"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:S,records:e})}),a=await (async()=>{try{return await t.json()}catch(e){return null}})();if(!t.ok){let e=a||await t.text().catch(()=>"");throw Error("Save failed (status ".concat(t.status,") ").concat("string"==typeof e?e:JSON.stringify(e)))}v(!1)}catch(e){i(e.message||String(e))}finally{L(!1)}}}return(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Điểm danh của gi\xe1o vi\xean"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("div",{className:"relative w-full max-w-xs",children:[(0,s.jsx)("input",{value:o,onChange:e=>u(e.target.value),placeholder:"T\xecm lớp hoặc kh\xf3a",className:"p-2 pr-8 border rounded w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"}),o&&(0,s.jsx)("button",{onClick:()=>u(""),className:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-700",children:"\xd7"})]}),(0,s.jsxs)("select",{value:h,onChange:e=>x(e.target.value),className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,s.jsx)("option",{value:"name",children:"Sắp theo lớp"}),(0,s.jsx)("option",{value:"course_name",children:"Sắp theo kh\xf3a"}),(0,s.jsx)("option",{value:"students",children:"Số học vi\xean"}),(0,s.jsx)("option",{value:"present",children:"C\xf3 mặt"}),(0,s.jsx)("option",{value:"absent",children:"Vắng"})]}),(0,s.jsxs)("select",{value:m,onChange:e=>p(e.target.value),className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,s.jsx)("option",{value:"asc",children:"Tăng"}),(0,s.jsx)("option",{value:"desc",children:"Giảm"})]}),(0,s.jsxs)("select",{value:b,onChange:e=>f(parseInt(e.target.value,10)),className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",children:[(0,s.jsx)("option",{value:5,children:"5"}),(0,s.jsx)("option",{value:10,children:"10"}),(0,s.jsx)("option",{value:20,children:"20"})]}),(0,s.jsx)("input",{type:"date",value:S,onChange:e=>{C(e.target.value),loadMyClasses(e.target.value)},className:"p-2 border rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"})]})]}),d&&(0,s.jsx)("div",{className:"mb-3 text-red-600",children:d}),(0,s.jsx)("div",{className:"bg-white dark:bg-slate-800 p-4 rounded",children:a?(0,s.jsx)("div",{children:"Loading..."}):(0,s.jsxs)("div",{children:[(0,s.jsxs)("table",{className:"w-full table-auto",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"text-left",children:[(0,s.jsx)("th",{className:"p-2",children:"Class"}),(0,s.jsx)("th",{className:"p-2",children:"Course"}),(0,s.jsx)("th",{className:"p-2",children:"Students"}),(0,s.jsx)("th",{className:"p-2",children:"C\xf3 mặt"}),(0,s.jsx)("th",{className:"p-2",children:"Vắng"}),(0,s.jsx)("th",{className:"p-2",children:"Actions"})]})}),(0,s.jsx)("tbody",{children:(()=>{let t=Array.isArray(e)?[...e]:[];if(o){let e=o.toLowerCase();t=t.filter(t=>(t.name||"").toLowerCase().includes(e)||(t.course_name||"").toLowerCase().includes(e))}t.sort((e,t)=>{let a="students"===h?e.student_count||0:"present"===h?e.present_count||0:"absent"===h?e.absent_count||0:(e[h]||"").toString().toLowerCase(),s="students"===h?t.student_count||0:"present"===h?t.present_count||0:"absent"===h?t.absent_count||0:(t[h]||"").toString().toLowerCase();return a<s?"asc"===m?-1:1:a>s?"asc"===m?1:-1:0});let a=(j-1)*b,s=a+b;return t.slice(a,s)})().map(e=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2",children:e.name||e.course_name||"Class ".concat(e.id)}),(0,s.jsx)("td",{className:"p-2",children:e.course_name||""}),(0,s.jsx)("td",{className:"p-2",children:e.student_count||0}),(0,s.jsx)("td",{className:"p-2",children:e.present_count||0}),(0,s.jsx)("td",{className:"p-2",children:e.absent_count||0}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsxs)("button",{onClick:()=>openAttendanceModal(e),className:"px-3 py-2 bg-indigo-600 text-white rounded flex items-center gap-2",children:[(0,s.jsx)(c.TCC,{})," Điểm danh"]})})]},e.id))})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between mt-3",children:[(0,s.jsxs)("div",{children:["Trang ",j," / ",totalPages()]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>g(e=>Math.max(1,e-1)),className:"px-3 py-1 border rounded",disabled:j<=1,children:"Trước"}),(0,s.jsx)("button",{onClick:()=>g(e=>Math.min(totalPages(),e+1)),className:"px-3 py-1 border rounded",disabled:j>=totalPages(),children:"Sau"})]})]})]})}),N&&(0,s.jsx)("div",{className:"fixed inset-0 flex items-center justify-center bg-black bg-opacity-40",children:(0,s.jsxs)("div",{className:"bg-white dark:bg-slate-800 p-4 rounded w-11/12 md:w-3/4 max-h-[90vh] overflow-auto",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsxs)("h2",{className:"text-lg font-semibold",children:["Điểm danh: ",w&&(w.name||w.course_name||"Class ".concat(w.id))]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{type:"date",value:S,onChange:e=>{C(e.target.value),loadMyClasses(e.target.value),w&&loadStudentsForClass(w.id,e.target.value)},className:"p-2 border rounded"}),(0,s.jsx)("button",{onClick:()=>v(!1),className:"px-3 py-1 border rounded",children:"Đ\xf3ng"})]})]}),(0,s.jsx)("div",{className:"overflow-auto",children:(0,s.jsxs)("table",{className:"w-full table-auto",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"text-left bg-gray-50 dark:bg-slate-700",children:[(0,s.jsx)("th",{className:"p-2",children:"Student"}),(0,s.jsx)("th",{className:"p-2",children:"Phone"}),(0,s.jsx)("th",{className:"p-2",children:"Status"})]})}),(0,s.jsx)("tbody",{children:_.map((e,t)=>(0,s.jsxs)("tr",{className:"border-t",children:[(0,s.jsx)("td",{className:"p-2",children:e.name}),(0,s.jsx)("td",{className:"p-2",children:e.phone}),(0,s.jsx)("td",{className:"p-2",children:(0,s.jsxs)("select",{value:e.status,onChange:e=>{var a;return a=e.target.value,void k(e=>e.map((e,s)=>s===t?{...e,status:a}:e))},className:"p-2 border rounded",children:[(0,s.jsx)("option",{value:"present",children:"C\xf3 mặt"}),(0,s.jsx)("option",{value:"absent",children:"Vắng"}),(0,s.jsx)("option",{value:"tardy",children:"Trễ"})]})})]},e.student_id))})]})}),(0,s.jsxs)("div",{className:"mt-3 flex justify-end gap-2",children:[(0,s.jsx)("button",{onClick:()=>v(!1),className:"px-3 py-2 border rounded",children:"Hủy"}),(0,s.jsx)("button",{disabled:A,onClick:saveAttendance,className:"px-3 py-2 bg-green-600 text-white rounded",children:A?"Đang lưu...":"Lưu điểm danh"})]})]})})]})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=4490)}),_N_E=e.O()}]);