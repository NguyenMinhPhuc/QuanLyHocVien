"use strict";(()=>{var e={};e.id=669,e.ids=[669,888,660],e.modules={3402:(e,t,s)=>{s.r(t),s.d(t,{config:()=>g,default:()=>p,getServerSideProps:()=>j,getStaticPaths:()=>b,getStaticProps:()=>m,reportWebVitals:()=>S,routeModule:()=>w,unstable_getServerProps:()=>C,unstable_getServerSideProps:()=>_,unstable_getStaticParams:()=>v,unstable_getStaticPaths:()=>f,unstable_getStaticProps:()=>N});var a={};s.r(a),s.d(a,{default:()=>DebtsPage});var l=s(7093),n=s(5244),i=s(1323),r=s(9209),d=s.n(r),c=s(181),o=s(997),h=s(6689),u=s(6686),x=s(5951);function qs(e){let t=encodeURIComponent;return Object.keys(e).filter(t=>void 0!==e[t]&&null!==e[t]&&""!==e[t]).map(s=>`${t(s)}=${t(e[s])}`).join("&")}function DebtsPage(){let[e,t]=(0,h.useState)([]),[s,a]=(0,h.useState)(""),[l,n]=(0,h.useState)("total_outstanding"),[i,r]=(0,h.useState)("DESC"),[d,c]=(0,h.useState)(1),[p,m]=(0,h.useState)(20),[b,j]=(0,h.useState)(0),[g,S]=(0,h.useState)(""),[N,f]=(0,h.useState)(""),[v,C]=(0,h.useState)("any"),[_,w]=(0,h.useState)(!1),[y,k]=(0,h.useState)(null),[P,D]=(0,h.useState)(!1),[A,E]=(0,h.useState)(null),[q,L]=(0,h.useState)(""),[T,O]=(0,h.useState)("cash"),[M,z]=(0,h.useState)(!1),[$,F]=(0,h.useState)([]),[R,H]=(0,h.useState)(!1);async function load(){w(!0);try{let e={q:s||void 0,sortField:l,sortDir:i,minOutstanding:g||void 0,maxOutstanding:N||void 0,hasDebt:"with"===v||"without"!==v&&void 0,page:d,pageSize:p},a="/api/students/debts"+(qs(e)?`?${qs(e)}`:""),n=await (0,u.S)(a);if(!n.ok){let e=await n.json().catch(()=>({}));throw Error(e.error||"Failed to load")}let r=await n.json();t(r.rows||[]),j(r.total||0),c(r.page||d),m(r.pageSize||p)}catch(e){k(e.message)}finally{w(!1)}}async function openStudentClasses(e){E(e),F([]),z(!0),H(!0);try{let t=await (0,u.S)(`/api/students/${e.id}/enrollments`);if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Failed to load enrollments")}let s=await t.json();F(s||[])}catch(e){k(e.message)}finally{H(!1)}}async function submitPay(e){if(e.preventDefault(),A)try{let e=Number(String(q||"").replace(/,/g,""));if(!e||e<=0)return k("Số tiền kh\xf4ng hợp lệ");let t=await (0,u.S)(`/api/students/${A.id}/pay`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,method:T})}),s=await t.json();if(!t.ok)throw Error(s.error||"Failed");D(!1),await load()}catch(e){k(e.message)}}return(0,h.useEffect)(()=>{load()},[s,l,i,d,p,g,N,v]),(0,o.jsxs)("div",{className:"p-4",children:[(0,o.jsxs)("div",{className:"mb-4",children:[o.jsx("h1",{className:"text-2xl font-semibold",children:(0,x.t)("debts.title","Quản l\xfd c\xf4ng nợ")}),o.jsx("div",{className:"mt-3 bg-white dark:bg-slate-800 p-3 rounded",children:(0,o.jsxs)("div",{className:"flex gap-2 items-center flex-wrap",children:[o.jsx("input",{placeholder:(0,x.t)("debts.search.placeholder","T\xecm kiếm t\xean hoặc sđt"),value:s,onChange:e=>{a(e.target.value),c(1)},className:"p-2 border rounded"}),o.jsx("input",{placeholder:(0,x.t)("debts.minOutstanding","Min nợ"),value:g,onChange:e=>{S(e.target.value),c(1)},className:"p-2 border rounded w-36"}),o.jsx("input",{placeholder:(0,x.t)("debts.maxOutstanding","Max nợ"),value:N,onChange:e=>{f(e.target.value),c(1)},className:"p-2 border rounded w-36"}),(0,o.jsxs)("select",{value:v,onChange:e=>{C(e.target.value),c(1)},className:"p-2 border rounded",children:[o.jsx("option",{value:"any",children:(0,x.t)("debts.filter.any","Tất cả")}),o.jsx("option",{value:"with",children:(0,x.t)("debts.filter.with","C\xf3 nợ")}),o.jsx("option",{value:"without",children:(0,x.t)("debts.filter.without","Kh\xf4ng nợ")})]}),(0,o.jsxs)("select",{value:p,onChange:e=>{m(Number(e.target.value)),c(1)},className:"p-2 border rounded",children:[o.jsx("option",{value:10,children:"10"}),o.jsx("option",{value:20,children:"20"}),o.jsx("option",{value:50,children:"50"})]})]})})]}),y&&o.jsx("div",{className:"text-red-600 mb-2",children:y}),o.jsx("div",{className:"bg-white dark:bg-slate-800 p-4 rounded",children:_?o.jsx("div",{children:"Loading..."}):(0,o.jsxs)("table",{className:"min-w-full table-auto",children:[o.jsx("thead",{children:(0,o.jsxs)("tr",{className:"text-left",children:[o.jsx("th",{className:"p-2",children:"No."}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"name"===l?r("ASC"===i?"DESC":"ASC"):(n("name"),r("ASC"))},children:(0,x.t)("debts.table.name","Họ t\xean")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"phone"===l?r("ASC"===i?"DESC":"ASC"):(n("phone"),r("ASC"))},children:(0,x.t)("debts.table.phone","SĐT")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"classes_active"===l?r("ASC"===i?"DESC":"ASC"):(n("classes_active"),r("DESC"))},children:(0,x.t)("debts.table.active","Lớp đang học")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"classes_finished"===l?r("ASC"===i?"DESC":"ASC"):(n("classes_finished"),r("DESC"))},children:(0,x.t)("debts.table.finished","Lớp đ\xe3 kết th\xfac")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"total_outstanding"===l?r("ASC"===i?"DESC":"ASC"):(n("total_outstanding"),r("DESC"))},children:(0,x.t)("debts.table.total_owed","Tổng nợ")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{"total_paid"===l?r("ASC"===i?"DESC":"ASC"):(n("total_paid"),r("DESC"))},children:(0,x.t)("debts.table.total_paid","Đ\xe3 thanh to\xe1n")}),o.jsx("th",{className:"p-2",children:(0,x.t)("debts.table.remaining","C\xf2n lại")}),o.jsx("th",{className:"p-2",children:(0,x.t)("debts.table.parent","Phụ huynh")}),o.jsx("th",{className:"p-2",children:(0,x.t)("debts.table.actions","H\xe0nh động")})]})}),o.jsx("tbody",{children:e.map((e,t)=>(0,o.jsxs)("tr",{className:"border-t",children:[o.jsx("td",{className:"p-2",children:(d-1)*p+t+1}),o.jsx("td",{className:"p-2",children:o.jsx("button",{onClick:()=>openStudentClasses(e),className:"text-left text-blue-600 dark:text-blue-300 underline",children:e.name})}),o.jsx("td",{className:"p-2",children:e.phone||"—"}),o.jsx("td",{className:"p-2",children:e.classes_active}),o.jsx("td",{className:"p-2",children:e.classes_finished}),o.jsx("td",{className:"p-2",children:Number(e.total_outstanding||0).toLocaleString()}),o.jsx("td",{className:"p-2",children:Number(e.total_paid||0).toLocaleString()}),o.jsx("td",{className:"p-2",children:Number((e.total_outstanding||0)-(e.total_paid||0)).toLocaleString()}),(0,o.jsxs)("td",{className:"p-2",children:[e.parent_name||"",e.parent_phone?` (${e.parent_phone})`:""]}),o.jsx("td",{className:"p-2",children:o.jsx("button",{onClick:()=>{E(e),L(""),O("cash"),D(!0)},className:"px-2 py-1 bg-green-600 text-white rounded",children:(0,x.t)("debts.actions.pay","Thanh to\xe1n")})})]},e.id))})]})}),(0,o.jsxs)("div",{className:"mt-4 flex items-center justify-between",children:[(0,o.jsxs)("div",{children:["Showing ",(d-1)*p+1," - ",Math.min(d*p,b)," of ",b]}),(0,o.jsxs)("div",{className:"flex gap-2",children:[o.jsx("button",{disabled:d<=1,onClick:()=>c(e=>Math.max(1,e-1)),className:"px-3 py-1 border rounded",children:"Prev"}),o.jsx("span",{className:"px-3 py-1",children:d}),o.jsx("button",{disabled:d*p>=b,onClick:()=>c(e=>e+1),className:"px-3 py-1 border rounded",children:"Next"})]})]}),P&&A&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>D(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:["Thanh to\xe1n — ",A.name]}),(0,o.jsxs)("form",{onSubmit:submitPay,className:"grid gap-2",children:[(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:"Amount"}),o.jsx("input",{type:"text",value:q,onChange:e=>L(e.target.value),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:"Method"}),(0,o.jsxs)("select",{value:T,onChange:e=>O(e.target.value),className:"p-2 border rounded w-full",children:[o.jsx("option",{value:"cash",children:"Tiền mặt"}),o.jsx("option",{value:"transfer",children:"Chuyển khoản"})]})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{type:"button",onClick:()=>D(!1),className:"px-3 py-2 border rounded",children:"Cancel"}),o.jsx("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:"Pay"})]})]})]})]}),M&&A&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>z(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-2xl z-60",children:[(0,o.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold",children:["Lớp đang tham gia — ",A.name]}),o.jsx("button",{onClick:()=>z(!1),className:"px-2 py-1 border rounded",children:"Đ\xf3ng"})]}),R?o.jsx("div",{children:"Loading..."}):(0,o.jsxs)("table",{className:"min-w-full table-auto",children:[o.jsx("thead",{children:(0,o.jsxs)("tr",{children:[o.jsx("th",{className:"p-2 text-left",children:"Class"}),o.jsx("th",{className:"p-2",children:"Reg date"}),o.jsx("th",{className:"p-2",children:"Status"}),o.jsx("th",{className:"p-2",children:"Outstanding"}),o.jsx("th",{className:"p-2",children:"Paid"})]})}),(0,o.jsxs)("tbody",{children:[0===$.length&&o.jsx("tr",{children:o.jsx("td",{colSpan:5,className:"p-2",children:"Kh\xf4ng c\xf3 lớp"})}),$.map(e=>(0,o.jsxs)("tr",{className:"border-t",children:[o.jsx("td",{className:"p-2",children:e.class_name||e.class_id}),o.jsx("td",{className:"p-2",children:e.registration_date?new Date(e.registration_date).toLocaleDateString():"—"}),o.jsx("td",{className:"p-2",children:e.status}),o.jsx("td",{className:"p-2",children:Number(e.outstanding_balance||0).toLocaleString()}),o.jsx("td",{className:"p-2",children:Number(e.total_paid||0).toLocaleString()})]},e.id))]})]})]})]})]})}let p=(0,i.l)(a,"default"),m=(0,i.l)(a,"getStaticProps"),b=(0,i.l)(a,"getStaticPaths"),j=(0,i.l)(a,"getServerSideProps"),g=(0,i.l)(a,"config"),S=(0,i.l)(a,"reportWebVitals"),N=(0,i.l)(a,"unstable_getStaticProps"),f=(0,i.l)(a,"unstable_getStaticPaths"),v=(0,i.l)(a,"unstable_getStaticParams"),C=(0,i.l)(a,"unstable_getServerProps"),_=(0,i.l)(a,"unstable_getServerSideProps"),w=new l.PagesRouteModule({definition:{kind:n.x.PAGES,page:"/debts",pathname:"/debts",bundlePath:"",filename:""},components:{App:c.default,Document:d()},userland:a})},2785:e=>{e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},6689:e=>{e.exports=require("react")},6405:e=>{e.exports=require("react-dom")},997:e=>{e.exports=require("react/jsx-runtime")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},9796:e=>{e.exports=require("zlib")}};var t=require("../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[761,199,209,450,181],()=>__webpack_exec__(3402));module.exports=s})();