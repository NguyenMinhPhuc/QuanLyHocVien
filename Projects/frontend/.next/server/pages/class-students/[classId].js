"use strict";(()=>{var e={};e.id=475,e.ids=[475,888,660],e.modules={4331:(e,t,s)=>{s.r(t),s.d(t,{config:()=>v,default:()=>g,getServerSideProps:()=>f,getStaticPaths:()=>b,getStaticProps:()=>_,reportWebVitals:()=>j,routeModule:()=>C,unstable_getServerProps:()=>S,unstable_getServerSideProps:()=>k,unstable_getStaticParams:()=>N,unstable_getStaticPaths:()=>w,unstable_getStaticProps:()=>y});var a={};s.r(a),s.d(a,{default:()=>ClassStudentsPage});var n=s(7093),i=s(5244),l=s(1323),r=s(9209),d=s.n(r),c=s(181),o=s(997),u=s(6689),h=s(7871),m=s(1163),x=s(6686),p=s(5951);function ClassStudentsPage(){let e=(0,m.useRouter)(),{classId:t}=e.query,[s,a]=(0,u.useState)([]),[n,i]=(0,u.useState)(null),[l,r]=(0,u.useState)(!1),[d,c]=(0,u.useState)(null),[g,_]=(0,u.useState)(!1),[b,f]=(0,u.useState)(null),[v,j]=(0,u.useState)(""),[y,w]=(0,u.useState)("cash"),[N,S]=(0,u.useState)([]),[k,C]=(0,u.useState)(!1),[T,$]=(0,u.useState)(""),[P,L]=(0,u.useState)([]),[D,z]=(0,u.useState)(""),[E,H]=(0,u.useState)(!1),[O,q]=(0,u.useState)(!1),[I,K]=(0,u.useState)({status:"",assigned_teacher_id:"",registration_date:""});async function load(){if(t){r(!0);try{let e=await (0,x.S)(`/api/classes/${t}/enrollments`);if(!e.ok)throw Error((0,p.t)("class_students.error.load_enrollments","Kh\xf4ng tải được danh s\xe1ch học vi\xean"));let s=await e.json();a(s);try{let e=await (0,x.S)(`/api/classes/${t}`);if(e.ok){let t=await e.json();i(t)}}catch(e){console.warn((0,p.t)("class_students.warn.load_class_info","Kh\xf4ng tải được th\xf4ng tin lớp"),e)}}catch(e){c(e.message)}finally{r(!1)}}}async function loadPayments(e){try{let t=await (0,x.S)(`/api/enrollments/${e}/payments`);if(!t.ok)return;S(await t.json())}catch(e){}}async function submitPayment(e){if(e.preventDefault(),b)try{let e=Number(String(v||"").replace(/,/g,""));if(!e||e<=0)return c((0,p.t)("pay.invalid_amount","Số tiền kh\xf4ng hợp lệ"));let t=await (0,x.S)(`/api/enrollments/${b.id}/payments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,method:y})}),s=await t.json();if(!t.ok)throw Error(s.error||(0,p.t)("class_students.error.add_payment","Kh\xf4ng thể th\xeam khoản thu"));if(j(""),w("cash"),await loadPayments(b.id),await load(),s&&s.receipt&&s.receipt.id)try{let e=await (0,x.S)(`/api/receipts/${s.receipt.id}`),t=null;e.ok&&(t=await e.json());let a=t&&t.receipt?t.receipt:s.receipt,n=t&&t.details?t.details:(()=>{try{return JSON.parse(a.data)}catch(e){return{}}})(),i=t&&t.settings?t.settings:{},l=Object.keys(n||{}).filter(e=>!["student_name","student_phone","class_name","amount","method","note"].includes(e)).map(e=>`<div class="row"><div>${e.replace(/_/g," ")}</div><div>${n[e]||""}</div></div>`).join(""),r=`<!doctype html><html><head><meta charset="utf-8"><title>Phiếu ${a.receipt_number}</title><style>body{font-family: Arial, Helvetica, sans-serif;padding:16px;font-size:12px} .container{width:420px;margin:0 auto} h1{font-size:16px;text-align:center} .row{display:flex;justify-content:space-between;margin:6px 0} .bold{font-weight:700}</style></head><body><div class="container">${i&&i.receipt_logo_url?`<div style="text-align:center;margin-bottom:6px"><img src="${i.receipt_logo_url}" style="max-height:60px"/></div>`:""}<h1>PHIẾU THU</h1><div class="row"><div>Phiếu số:</div><div class="bold">${a.receipt_number}</div></div><div class="row"><div>Ng\xe0y:</div><div class="bold">${new Date(a.created_at).toLocaleString()}</div></div><hr><div class="row"><div>Học sinh:</div><div>${n&&n.student_name?n.student_name:""}</div></div><div class="row"><div>SDT học sinh:</div><div>${n&&n.student_phone?n.student_phone:""}</div></div><div class="row"><div>Lớp / Kh\xf3a:</div><div>${n&&n.class_name?n.class_name:""}</div></div><div class="row"><div>Số tiền:</div><div class="bold">${Number(n&&n.amount||0).toLocaleString()} đ</div></div><div class="row"><div>H\xecnh thức:</div><div>${n&&n.method||""}</div></div>${l}${i&&i.receipt_center_phone?`<div class="row"><div>Điện thoại:</div><div>${i.receipt_center_phone}</div></div>`:""}<div style="margin-top:20px">Người thu: ____________________</div><div style="margin-top:40px;font-size:11px;color:#666">Ghi ch\xfa: ${n&&n.note?n.note:""}</div></div></body></html>`,d=window.open("","_blank","width=600,height=800");d.document.write(r),d.document.close(),setTimeout(()=>{try{d.print()}catch(e){console.warn("print failed",e)}},500)}catch(e){console.error("Failed to open receipt",e)}}catch(e){c(e.message)}}function openTransfer(e){f(e),(async()=>{try{let t=[];if("reserved"===String(e.status||"").toLowerCase()){let e=await (0,x.S)("/api/classes/active");e.ok&&(t=await e.json()),console.log("[openTransfer] candidates (all active) from server",t&&t.length)}else{let s=await (0,x.S)(`/api/classes/${e.class_id}`);if(!s.ok){c("Kh\xf4ng lấy được th\xf4ng tin lớp nguồn"),C(!0);return}let a=await s.json();console.log("[openTransfer] classInfo",a);let n=a.course_id;if(n){let e=await (0,x.S)(`/api/classes/course/${n}/active`);e.ok&&(t=await e.json()),console.log("[openTransfer] candidates (same course) from server",t&&t.length)}else console.log("[openTransfer] no courseId, cannot fetch candidates")}L(t||[]),$("")}catch(e){console.error("openTransfer error",e),c("Lỗi khi tải danh s\xe1ch lớp chuyển")}finally{C(!0)}})()}async function submitTransfer(){if(b){if(!T)return c((0,p.t)("class_students.transfer.error.pick_target","Vui l\xf2ng chọn lớp đ\xedch"));try{let e=await (0,x.S)(`/api/enrollments/${b.id}/transfer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({new_class_id:Number(T)})});if(!e.ok){let t=await e.json().catch(()=>({}));throw Error(t.error||"Failed")}C(!1),$(""),await load()}catch(e){c(e.message)}}}async function holdEnrollmentAction(e){if(e&&e.id)try{let t=window.prompt("L\xfd do bảo lưu (t\xf9y chọn):","")||"",s=await (0,x.S)(`/api/enrollments/${e.id}/hold`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"hold",reason:t})}),a=await s.json().catch(()=>({}));if(!s.ok)throw Error(a.error||"Kh\xf4ng thể bảo lưu");await load()}catch(e){c(e.message)}}async function assignBackToClass(e){e&&openTransfer(e)}async function submitEdit(e){if(e.preventDefault(),b)try{let e={...I};if(e.registration_date&&""!==String(e.registration_date).trim())try{e.registration_date=new Date(e.registration_date).toISOString()}catch(e){}else e.registration_date=null;let t=await (0,x.S)(`/api/enrollments/${b.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json();if(!t.ok)throw Error(s.error||"Failed");q(!1),await load()}catch(e){c(e.message)}}async function addEnrollment(){e.push("/classes")}return(0,u.useEffect)(()=>{load()},[t]),(0,o.jsxs)("div",{className:"p-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,o.jsxs)("h1",{className:"text-2xl font-semibold",children:[(0,p.t)("class_students.title","Học vi\xean trong")," ",n&&(n.course_name||n.name)||`Class ${t}`]}),o.jsx("div",{children:o.jsx("button",{onClick:addEnrollment,className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,p.t)("class_students.enroll","Ghi danh học vi\xean")})})]}),d&&o.jsx("div",{className:"text-red-600 mb-2",children:d}),o.jsx("div",{className:"bg-white dark:bg-slate-800 dark:text-slate-100 p-4 rounded",children:l?o.jsx("div",{children:(0,p.t)("actions.loading","Đang tải...")}):(0,o.jsxs)("table",{className:"min-w-full table-auto",children:[o.jsx("thead",{children:(0,o.jsxs)("tr",{className:"text-left",children:[o.jsx("th",{className:"p-2",children:(0,p.t)("debts.table.no","STT")}),o.jsx("th",{children:(0,p.t)("debts.table.name","Họ t\xean")}),o.jsx("th",{children:(0,p.t)("class_students.col.reg_date","Ng\xe0y đăng k\xfd")}),o.jsx("th",{children:(0,p.t)("class_students.col.status","Trạng th\xe1i")}),o.jsx("th",{children:(0,p.t)("class_students.col.debt_paid","Nợ / Đ\xe3 trả")}),o.jsx("th",{children:(0,p.t)("actions.actions","Thao t\xe1c")})]})}),o.jsx("tbody",{children:s.map((e,t)=>(0,o.jsxs)("tr",{className:"border-t",children:[o.jsx("td",{className:"p-2",children:t+1}),o.jsx("td",{className:"p-2",children:e.student_name}),o.jsx("td",{className:"p-2",children:e.registration_date||"—"}),o.jsx("td",{className:"p-2",children:e.status}),(0,o.jsxs)("td",{className:"p-2",children:[(0,o.jsxs)("div",{className:"text-sm text-slate-700 dark:text-slate-200 mb-1",children:["Nợ: ",o.jsx("strong",{children:null!=e.outstanding_balance?Number(e.outstanding_balance).toLocaleString():"—"})]}),(0,o.jsxs)("div",{className:"text-sm text-slate-500 dark:text-slate-400",children:["Đ\xe3 trả: ",o.jsx("strong",{children:Number(e.total_paid||0).toLocaleString()})]})]}),(0,o.jsxs)("td",{className:"p-2",children:[o.jsx("button",{onClick:()=>(function(e){f(e);try{let t=e&&null!=e.outstanding_balance?String(Number(e.outstanding_balance)):"";j((0,h.x)(t))}catch(e){j("")}_(!0),loadPayments(e.id)})(e),className:"mr-2 px-2 py-1 bg-blue-500 text-white rounded",children:(0,p.t)("class_students.btn.payments","Thu tiền")}),o.jsx("button",{onClick:()=>(function(e){f(e);let t="";if(e&&e.registration_date)try{let s=new Date(e.registration_date);isNaN(s.getTime())||(t=s.toISOString().slice(0,10))}catch(e){t=""}K({status:e.status||"",assigned_teacher_id:e.assigned_teacher_id||"",registration_date:t}),q(!0)})(e),className:"mr-2 px-2 py-1 bg-yellow-500 text-white rounded",children:(0,p.t)("class_students.btn.edit","Chỉnh sửa")}),o.jsx("button",{onClick:()=>openTransfer(e),className:"mr-2 px-2 py-1 bg-indigo-600 text-white rounded",children:(0,p.t)("class_students.btn.transfer","Chuyển lớp")}),"reserved"!==String(e.status||"").toLowerCase()?o.jsx("button",{onClick:()=>holdEnrollmentAction(e),className:"ml-2 px-2 py-1 bg-gray-600 text-white rounded",children:"Bảo lưu"}):o.jsx("button",{onClick:()=>assignBackToClass(e),className:"ml-2 px-2 py-1 bg-green-600 text-white rounded",children:"G\xe1n lại"})]})]},e.id))})]})}),g&&b&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>_(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-lg z-60",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,p.t)("class_students.payments.title","Thu tiền")," — ",b.student_name]}),(0,o.jsxs)("div",{className:"mb-3 text-sm text-slate-700 dark:text-slate-200",children:[(0,p.t)("class_students.payments.outstanding","Số tiền nợ hiện tại"),": ",o.jsx("strong",{children:null!=b.outstanding_balance?Number(b.outstanding_balance).toLocaleString():"—"})]}),o.jsx("div",{className:"mb-3",children:(0,o.jsxs)("form",{onSubmit:submitPayment,className:"grid grid-cols-1 gap-2",children:[(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,p.t)("class_students.payments.amount","Số tiền")}),o.jsx("input",{type:"text",inputMode:"decimal",value:(0,h.U)(v),onChange:e=>j((0,h.x)(e.target.value)),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,p.t)("class_students.payments.method","H\xecnh thức")}),(0,o.jsxs)("select",{value:y,onChange:e=>w(e.target.value),className:"p-2 border rounded w-full",children:[o.jsx("option",{value:"cash",children:"Tiền mặt"}),o.jsx("option",{value:"transfer",children:"Chuyển khoản"})]})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{type:"button",onClick:()=>_(!1),className:"px-3 py-2 border rounded",children:(0,p.t)("actions.cancel","Hủy")}),o.jsx("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,p.t)("class_students.payments.add","Th\xeam khoản thu")})]})]})}),(0,o.jsxs)("div",{children:[o.jsx("h4",{className:"font-semibold mb-2",children:(0,p.t)("class_students.payments.history","Lịch sử")}),(0,o.jsxs)("table",{className:"min-w-full table-auto",children:[o.jsx("thead",{children:(0,o.jsxs)("tr",{children:[o.jsx("th",{children:(0,p.t)("class_students.payments.col.paid_at","Thời gian")}),o.jsx("th",{children:(0,p.t)("class_students.payments.col.amount","Số tiền")}),o.jsx("th",{children:(0,p.t)("class_students.payments.col.method","H\xecnh thức")}),o.jsx("th",{children:(0,p.t)("class_students.payments.col.note","Ghi ch\xfa")})]})}),o.jsx("tbody",{children:N.map(e=>(0,o.jsxs)("tr",{children:[o.jsx("td",{children:new Date(e.paid_at).toLocaleString()}),o.jsx("td",{children:Number(e.amount).toLocaleString()}),o.jsx("td",{children:e.method}),o.jsx("td",{children:e.note})]},e.id))})]})]})]})]}),k&&b&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>C(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,p.t)("class_students.transfer.title","Chuyển lớp")," — ",b.student_name]}),(0,o.jsxs)("div",{className:"grid gap-2",children:[o.jsx("label",{className:"block text-sm font-medium",children:"reserved"===String(b?.status||"").toLowerCase()?(0,p.t)("class_students.transfer.label.active","Chọn lớp đ\xedch (lớp đang hoạt động)"):(0,p.t)("class_students.transfer.label.same_course","Chọn lớp đ\xedch (c\xf9ng kh\xf3a, chưa kết th\xfac)")}),(0,o.jsxs)("div",{className:"relative",children:[o.jsx("input",{placeholder:(0,p.t)("class_students.transfer.search_placeholder","T\xecm lớp..."),value:D,onChange:e=>{z(e.target.value),H(!0),$("")},onFocus:()=>H(!0),className:"p-2 border rounded w-full"}),(0,o.jsxs)("div",{className:`absolute left-0 right-0 mt-1 bg-white dark:bg-slate-800 dark:border-slate-700 border rounded max-h-56 overflow-auto z-40 ${E?"":"hidden"}`,children:[(P||[]).filter(e=>{let t=(D||"").toLowerCase().trim(),s=`${e.course_name||e.name||"Class "+e.id} ${e.teacher_name||e.teacher||""}`.toLowerCase();return!t||s.includes(t)}).map(e=>{let t=`#${e.id} — ${e.course_name||e.name||"Class "+e.id} — ${e.teacher_name||e.teacher||"TBA"}`;return(0,o.jsxs)("div",{onMouseDown:()=>{$(String(e.id)),z(t),H(!1)},className:"px-3 py-2 hover:bg-gray-100 cursor-pointer",children:[o.jsx("div",{className:"font-medium",children:t}),(0,o.jsxs)("div",{className:"text-sm text-slate-500",children:[e.course_start_date?new Date(e.course_start_date).toLocaleDateString():"start?"," → ",e.course_end_date?new Date(e.course_end_date).toLocaleDateString():"ongoing"]})]},e.id)}),0===(P||[]).filter(e=>{let t=(D||"").toLowerCase().trim(),s=`${e.id} ${e.course_name||e.course_id}`.toLowerCase();return!t||s.includes(t)}).length&&o.jsx("div",{className:"p-2 text-sm text-slate-500",children:(0,p.t)("class_students.transfer.none","Kh\xf4ng t\xecm thấy lớp")})]})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{onClick:()=>C(!1),className:"px-3 py-2 border rounded",children:(0,p.t)("actions.cancel","Hủy")}),o.jsx("button",{onClick:submitTransfer,className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,p.t)("class_students.transfer.submit","Chuyển lớp")})]})]})]})]}),O&&b&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>q(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[(0,o.jsxs)("h3",{className:"text-lg font-semibold mb-2",children:[(0,p.t)("class_students.edit.title","Chỉnh sửa ghi danh")," — ",b.student_name]}),(0,o.jsxs)("form",{onSubmit:submitEdit,className:"grid gap-2",children:[(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,p.t)("class_students.edit.status","Trạng th\xe1i")}),(0,o.jsxs)("select",{value:I.status,onChange:e=>K(t=>({...t,status:e.target.value})),className:"p-2 border rounded w-full",children:[o.jsx("option",{value:"active",children:(0,p.t)("class_students.status.active","K\xedch hoạt")}),o.jsx("option",{value:"reserved",children:(0,p.t)("class_students.status.reserved","Bảo lưu")}),o.jsx("option",{value:"withdrawn",children:(0,p.t)("class_students.status.withdrawn","R\xfat")})]})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,p.t)("class_students.edit.registration_date","Ng\xe0y đăng k\xfd")}),o.jsx("input",{type:"date",value:I.registration_date||"",onChange:e=>K(t=>({...t,registration_date:e.target.value})),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,p.t)("class_students.edit.assigned_teacher_id","ID gi\xe1o vi\xean")}),o.jsx("input",{value:I.assigned_teacher_id||"",onChange:e=>K(t=>({...t,assigned_teacher_id:e.target.value})),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{type:"button",onClick:()=>q(!1),className:"px-3 py-2 border rounded",children:(0,p.t)("actions.cancel","Hủy")}),o.jsx("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,p.t)("actions.confirm","Lưu")})]})]})]})]})]})}let g=(0,l.l)(a,"default"),_=(0,l.l)(a,"getStaticProps"),b=(0,l.l)(a,"getStaticPaths"),f=(0,l.l)(a,"getServerSideProps"),v=(0,l.l)(a,"config"),j=(0,l.l)(a,"reportWebVitals"),y=(0,l.l)(a,"unstable_getStaticProps"),w=(0,l.l)(a,"unstable_getStaticPaths"),N=(0,l.l)(a,"unstable_getStaticParams"),S=(0,l.l)(a,"unstable_getServerProps"),k=(0,l.l)(a,"unstable_getServerSideProps"),C=new n.PagesRouteModule({definition:{kind:i.x.PAGES,page:"/class-students/[classId]",pathname:"/class-students/[classId]",bundlePath:"",filename:""},components:{App:c.default,Document:d()},userland:a})},7871:(e,t,s)=>{function sanitizeNumericInput(e){if(null==e)return"";let t=String(e);t=t.replace(/[^0-9.]/g,"");let s=t.split(".");return s.length>2&&(t=s[0]+"."+s.slice(1).join("")),t}function formatWithThousands(e){if(null==e||""===e)return"";let t=String(e).replace(/,/g,"");if(t.indexOf(".")>=0){let[e,s]=t.split("."),a=Number(e||0).toLocaleString();return s?`${a}.${s}`:`${a}.`}return Number(t).toLocaleString()}s.d(t,{U:()=>formatWithThousands,x:()=>sanitizeNumericInput})},2785:e=>{e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},6689:e=>{e.exports=require("react")},6405:e=>{e.exports=require("react-dom")},997:e=>{e.exports=require("react/jsx-runtime")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},9796:e=>{e.exports=require("zlib")}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[761,199,209,450,181],()=>__webpack_exec__(4331));module.exports=s})();