"use strict";(()=>{var e={};e.id=91,e.ids=[91,888,660],e.modules={4776:(e,t,s)=>{s.r(t),s.d(t,{config:()=>y,default:()=>p,getServerSideProps:()=>b,getStaticPaths:()=>g,getStaticProps:()=>x,reportWebVitals:()=>f,routeModule:()=>_,unstable_getServerProps:()=>k,unstable_getServerSideProps:()=>S,unstable_getStaticParams:()=>N,unstable_getStaticPaths:()=>w,unstable_getStaticProps:()=>j});var a={};s.r(a),s.d(a,{default:()=>SchedulesPage});var l=s(7093),r=s(5244),d=s(1323),i=s(9209),c=s.n(i),n=s(181),o=s(997),u=s(6689),h=s(6686),m=s(5951);function SchedulesPage(){let[e,t]=(0,u.useState)([]),[s,a]=(0,u.useState)(""),[l,r]=(0,u.useState)(1),[d,i]=(0,u.useState)(10),[c,n]=(0,u.useState)(0),[p,x]=(0,u.useState)("id"),[g,b]=(0,u.useState)("asc"),[y,f]=(0,u.useState)([]),[j,w]=(0,u.useState)(""),[N,k]=(0,u.useState)(""),[S,_]=(0,u.useState)(!1),[v,T]=(0,u.useState)(null),[C,P]=(0,u.useState)(!1),[$,D]=(0,u.useState)(!1),[A,E]=(0,u.useState)(null),[q,L]=(0,u.useState)(1),[M,U]=(0,u.useState)({id:null,class_id:"",weekday:0,start_time:"08:00",end_time:"09:30"}),I=[(0,m.t)("schedules.weekday.0","Chủ nhật"),(0,m.t)("schedules.weekday.1","Thứ 2"),(0,m.t)("schedules.weekday.2","Thứ 3"),(0,m.t)("schedules.weekday.3","Thứ 4"),(0,m.t)("schedules.weekday.4","Thứ 5"),(0,m.t)("schedules.weekday.5","Thứ 6"),(0,m.t)("schedules.weekday.6","Thứ 7")];function dbWeekdayToIndex(e){if(null==e||""===e)return null;let t=Number(e);if(isNaN(t))return null;let s=t-1;return s>=0&&s<=6?s:null}function indexToDbWeekday(e){let t=Number(e);return isNaN(t)?null:t+1}async function load(){_(!0);try{let e=new URLSearchParams;s&&e.set("q",s),N&&e.set("classId",N),e.set("page",l),e.set("pageSize",d),p&&e.set("sortField",p),g&&e.set("sortDir",g);let[a,r]=await Promise.all([(0,h.S)("/api/schedules?"+e.toString()),(0,h.S)("/api/classes")]);if(!a.ok)throw Error("Failed to load schedules");let i=await a.json(),c=i&&i.rows?i.rows:i;if(t(c||[]),n(i&&i.total?Number(i.total):0),r.ok){let e=await r.json();Array.isArray(e)||(e=e&&Array.isArray(e.rows)?e.rows:e&&Array.isArray(e.items)?e.items:[]),f(e||[])}else f([])}catch(e){T(e.message)}finally{_(!1)}}function formatTime(e){if(!e)return"";try{if(e instanceof Date){let t=e.getFullYear(),s=t<=1970?e.getUTCHours():e.getHours(),a=t<=1970?e.getUTCMinutes():e.getMinutes();return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`}let t=String(e);if(t.includes("T")){let e=new Date(t);if(!isNaN(e.getTime()))return e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}let s=t.split(":");if(s.length>=2)return`${s[0].padStart(2,"0")}:${s[1].padStart(2,"0")}`;return t.slice(0,5)}catch(t){return e}}function parseTimeForInput(e){if(!e)return"";try{if(e instanceof Date){let t=e.getFullYear(),s=t<=1970?e.getUTCHours():e.getHours(),a=t<=1970?e.getUTCMinutes():e.getMinutes();return`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`}let t=String(e);if(t.includes("T")){let e=new Date(t);if(!isNaN(e.getTime())){let t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${t}:${s}`}}let s=t.split(":");if(s.length>=2)return`${s[0].padStart(2,"0")}:${s[1].padStart(2,"0")}`;return t.slice(0,5)}catch(e){return""}}async function submit(e){e.preventDefault();try{let e;if(!M.schedule_date){T((0,m.t)("schedules.error.date_required","Vui l\xf2ng chọn ng\xe0y"));return}let t={class_id:Number(M.class_id),start_time:M.start_time,end_time:M.end_time,schedule_date:M.schedule_date};if(Array.isArray(M.weekdays)&&M.weekdays.length>0?t.weekdays=M.weekdays.map(e=>indexToDbWeekday(e)):t.weekday=indexToDbWeekday(M.weekday),!(e=M.id?await (0,h.S)(`/api/schedules/${M.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}):await (0,h.S)("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}))||!e.ok){let t="";try{t=await e.text()}catch(e){t=String(e)}console.error("[schedules.submit] non-ok response",e&&e.status,t);let s=(()=>{try{return JSON.parse(t)}catch(e){return null}})();throw Error(s&&s.error?s.error:`Server error: ${e&&e.status} ${t}`)}P(!1),await load()}catch(e){T(e.message)}}async function remove(e){if(window.confirm((0,m.t)("class_students.confirm_delete","X\xe1c nhận x\xf3a?")))try{let t=await (0,h.S)(`/api/schedules/${e}`,{method:"DELETE"});if(!t||!t.ok){let e="";try{e=await t.text()}catch(t){e=String(t)}throw console.error("[schedules.remove] delete failed",t&&t.status,e),Error(`Delete failed: ${t&&t.status}`)}await load()}catch(e){T(e.message)}}return(0,u.useEffect)(()=>{load()},[]),(0,u.useEffect)(()=>{load()},[s,l,d,p,g,N]),(0,o.jsxs)("div",{className:"p-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[o.jsx("h1",{className:"text-2xl font-semibold",children:(0,m.t)("schedules.title","Quản l\xfd lịch")}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[o.jsx("input",{placeholder:(0,m.t)("schedules.search.placeholder","T\xecm kiếm..."),value:s,onChange:e=>{a(e.target.value),r(1)},className:"p-2 border rounded"}),(0,o.jsxs)("select",{value:N,onChange:e=>{k(e.target.value),r(1)},className:"p-2 border rounded",children:[o.jsx("option",{value:"",children:(0,m.t)("schedules.filter.all_classes","-- Tất cả lớp --")}),(y||[]).map(e=>o.jsx("option",{value:e.id,children:e.course_name||e.name||`Class ${e.id}`},e.id))]}),(0,o.jsxs)("select",{value:d,onChange:e=>{i(Number(e.target.value)),r(1)},className:"p-2 border rounded",children:[o.jsx("option",{value:5,children:"5"}),o.jsx("option",{value:10,children:"10"}),o.jsx("option",{value:20,children:"20"}),o.jsx("option",{value:50,children:"50"})]}),o.jsx("button",{onClick:function(){U({id:null,class_id:"",weekdays:[],weekday:0,schedule_date:"",start_time:"08:00",end_time:"09:30"}),P(!0)},className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,m.t)("schedules.create","Tạo lịch")}),(0,o.jsxs)("select",{value:j,onChange:e=>w(e.target.value),className:"p-2 border rounded",children:[o.jsx("option",{value:"",children:(0,m.t)("schedules.export.all","Tất cả lớp")}),(y||[]).map(e=>o.jsx("option",{value:e.id,children:e.course_name||e.name||`Class ${e.id}`},e.id))]}),o.jsx("button",{onClick:async()=>{try{let e=new URLSearchParams;j&&e.set("classId",j);let t=await (0,h.S)("/api/schedules/export.ics"+(e.toString()?"?"+e.toString():""));if(!t.ok)throw Error("Export failed");let s=await t.blob(),a=window.URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download="schedules.ics",document.body.appendChild(l),l.click(),l.remove(),window.URL.revokeObjectURL(a)}catch(e){T(e.message)}},className:"px-3 py-2 border rounded",children:(0,m.t)("schedules.export_button","Export .ics")})]})]}),v&&o.jsx("div",{className:"text-red-600 mb-2",children:v}),o.jsx("div",{className:"bg-white dark:bg-slate-800 dark:text-slate-100 p-4 rounded",children:S?o.jsx("div",{children:(0,m.t)("actions.loading","Đang tải...")}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("table",{className:"min-w-full table-auto",children:[o.jsx("thead",{children:(0,o.jsxs)("tr",{className:"text-left",children:[o.jsx("th",{className:"p-2",children:(0,m.t)("debts.table.no","STT")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{x("class_id"),b("class_id"===p&&"asc"===g?"desc":"asc")},children:(0,m.t)("schedules.col.class","Lớp")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{x("schedule_date"),b("schedule_date"===p&&"asc"===g?"desc":"asc")},children:(0,m.t)("schedules.col.date","Ng\xe0y")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{x("weekday"),b("weekday"===p&&"asc"===g?"desc":"asc")},children:(0,m.t)("schedules.col.weekday","Thứ")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{x("start_time"),b("start_time"===p&&"asc"===g?"desc":"asc")},children:(0,m.t)("schedules.col.start","Bắt đầu")}),o.jsx("th",{className:"p-2 cursor-pointer",onClick:()=>{x("end_time"),b("end_time"===p&&"asc"===g?"desc":"asc")},children:(0,m.t)("schedules.col.end","Kết th\xfac")}),o.jsx("th",{children:(0,m.t)("actions.actions","Thao t\xe1c")})]})}),o.jsx("tbody",{children:(e||[]).map((e,t)=>{let s=e&&(e.schedule_date||e.date)?new Date(e.schedule_date||e.date).toLocaleDateString():"-",a=null;void 0!==e.weekday&&null!==e.weekday?a=dbWeekdayToIndex(e.weekday):e.schedule_date&&(a=new Date(e.schedule_date).getDay());let l=null!=a?I[a]:"-";return(0,o.jsxs)("tr",{className:"border-t",children:[o.jsx("td",{className:"p-2",children:t+1}),(0,o.jsxs)("td",{className:"p-2",children:[o.jsx("div",{children:function(e){let t=(y||[]).find(t=>Number(t.id)===Number(e));return t?t.course_name||t.name||t.course||`Class ${e}`:e}(e.class_id)}),(0,o.jsxs)("div",{className:"text-sm text-slate-500",children:[e.teacher_name||"",e.teacher_phone?` • ${e.teacher_phone}`:""]})]}),o.jsx("td",{className:"p-2",children:s}),o.jsx("td",{className:"p-2",children:l}),o.jsx("td",{className:"p-2",children:formatTime(e.start_time)}),o.jsx("td",{className:"p-2",children:formatTime(e.end_time)}),(0,o.jsxs)("td",{className:"p-2",children:[o.jsx("button",{onClick:()=>{U({id:e.id,class_id:e.class_id,weekdays:Array.isArray(e.weekdays)?e.weekdays.map(dbWeekdayToIndex).filter(e=>null!==e):void 0!==e.weekday&&null!==e.weekday?[dbWeekdayToIndex(e.weekday)]:[],weekday:dbWeekdayToIndex(e.weekday),schedule_date:function(e){if(!e)return"";try{let t=String(e);if(t.includes("T"))return t.split("T")[0];if(t.match(/\d{4}-\d{2}-\d{2}/))return t.match(/\d{4}-\d{2}-\d{2}/)[0];let s=new Date(t);if(!isNaN(s.getTime()))return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}catch(e){}return""}(e.schedule_date||e.date||e.schedule_date),start_time:parseTimeForInput(e.start_time),end_time:parseTimeForInput(e.end_time)}),P(!0)},className:"mr-2 px-2 py-1 bg-yellow-500 text-white rounded",children:(0,m.t)("actions.edit","Sửa")}),o.jsx("button",{onClick:()=>remove(e.id),className:"mr-2 px-2 py-1 bg-red-600 text-white rounded",children:(0,m.t)("actions.delete","X\xf3a")}),o.jsx("button",{onClick:()=>{E(e),L(1),D(!0)},className:"px-2 py-1 bg-blue-600 text-white rounded",children:(0,m.t)("schedules.copy","Sao ch\xe9p")})]})]},e.id)})})]}),(0,o.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,o.jsxs)("div",{className:"text-sm",children:[(0,m.t)("schedules.pagination.total","Tổng"),": ",c]}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[o.jsx("button",{onClick:()=>r(1),disabled:l<=1,className:"px-2 py-1 border rounded",children:(0,m.t)("pagination.first","Đầu")}),o.jsx("button",{onClick:()=>r(e=>Math.max(1,e-1)),disabled:l<=1,className:"px-2 py-1 border rounded",children:(0,m.t)("pagination.prev","Trước")}),o.jsx("div",{className:"px-2",children:l}),o.jsx("button",{onClick:()=>r(e=>e+1),disabled:l*d>=c,className:"px-2 py-1 border rounded",children:(0,m.t)("pagination.next","Sau")}),o.jsx("button",{onClick:()=>r(Math.max(1,Math.ceil(c/d))),disabled:l*d>=c,className:"px-2 py-1 border rounded",children:(0,m.t)("pagination.last","Cuối")})]})]})]})}),C&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>P(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-md z-60",children:[o.jsx("h3",{className:"text-lg font-semibold mb-2",children:M.id?(0,m.t)("schedules.edit_title","Sửa lịch"):(0,m.t)("schedules.create_title","Tạo lịch")}),(0,o.jsxs)("form",{onSubmit:submit,className:"grid gap-2",children:[(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.form.class","Lớp")}),(0,o.jsxs)("select",{value:M.class_id,onChange:e=>U(t=>({...t,class_id:e.target.value})),className:"p-2 border rounded w-full",children:[o.jsx("option",{value:"",children:(0,m.t)("schedules.form.select_class","-- Chọn lớp --")}),(y||[]).map(e=>o.jsx("option",{value:e.id,children:e.course_name||e.name||e.course||`Class ${e.id}`},e.id))]}),0===(y||[]).length&&o.jsx("div",{className:"text-sm text-slate-500 mt-1",children:(0,m.t)("schedules.no_classes","Chưa c\xf3 lớp n\xe0o. Vui l\xf2ng tạo lớp trước khi th\xeam lịch.")})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.form.weekdays","Chọn ng\xe0y lặp lại")}),o.jsx("div",{className:"grid grid-cols-4 gap-2",children:I.map((e,t)=>(0,o.jsxs)("label",{className:"flex items-center gap-2",children:[o.jsx("input",{type:"checkbox",checked:Array.isArray(M.weekdays)?M.weekdays.includes(t):Number(M.weekday)===t,onChange:e=>{let s=e.target.checked;U(e=>{let a=Array.isArray(e.weekdays)?[...e.weekdays]:[e.weekday];if(s)a.includes(t)||a.push(t);else{let e=a.indexOf(t);-1!==e&&a.splice(e,1)}return{...e,weekdays:a}})}}),o.jsx("span",{className:"text-sm",children:e})]},t))})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.form.specific_date","Ng\xe0y cụ thể (t\xf9y chọn)")}),o.jsx("input",{required:!0,type:"date",value:M.schedule_date||"",onChange:e=>U(t=>({...t,schedule_date:e.target.value})),className:"p-2 border rounded w-full"}),o.jsx("div",{className:"text-xs text-slate-500 mt-1",children:(0,m.t)("schedules.form.specific_date_help","Nếu đặt ng\xe0y, lịch n\xe0y sẽ l\xe0 buổi cụ thể thay v\xec lặp theo thứ")})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.form.start_time","Bắt đầu")}),o.jsx("input",{type:"time",value:M.start_time,onChange:e=>U(t=>({...t,start_time:e.target.value})),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.form.end_time","Kết th\xfac")}),o.jsx("input",{type:"time",value:M.end_time,onChange:e=>U(t=>({...t,end_time:e.target.value})),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{type:"button",onClick:()=>P(!1),className:"px-3 py-2 border rounded",children:(0,m.t)("actions.cancel","Hủy")}),o.jsx("button",{type:"submit",className:"px-3 py-2 bg-green-600 text-white rounded",children:(0,m.t)("actions.confirm","Lưu")})]})]})]})]}),$&&A&&(0,o.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[o.jsx("div",{className:"absolute inset-0 bg-black opacity-40",onClick:()=>D(!1)}),(0,o.jsxs)("div",{className:"relative bg-white dark:bg-slate-800 dark:text-slate-100 p-6 rounded w-full max-w-sm z-60",children:[o.jsx("h3",{className:"text-lg font-semibold mb-2",children:(0,m.t)("schedules.copy_title","Sao ch\xe9p lịch")}),o.jsx("div",{className:"mb-2",children:(0,m.t)("schedules.copy_help","Chọn số buổi sẽ được tạo tiếp theo h\xe0ng tuần")}),(0,o.jsxs)("div",{className:"grid gap-2",children:[(0,o.jsxs)("div",{children:[o.jsx("label",{className:"block text-sm",children:(0,m.t)("schedules.copy.count","Số buổi")}),o.jsx("input",{type:"number",min:1,value:q,onChange:e=>L(Math.max(1,Number(e.target.value||1))),className:"p-2 border rounded w-full"})]}),(0,o.jsxs)("div",{className:"flex gap-2 justify-end",children:[o.jsx("button",{type:"button",onClick:()=>D(!1),className:"px-3 py-2 border rounded",children:(0,m.t)("actions.cancel","Hủy")}),o.jsx("button",{type:"button",onClick:async()=>{try{let e=await (0,h.S)(`/api/schedules/${A.id}/copy`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({count:q})});if(!e.ok){let t="";try{t=await e.text()}catch(e){t=e.message}throw Error(t||"Copy failed")}D(!1),await load()}catch(e){T(e.message)}},className:"px-3 py-2 bg-blue-600 text-white rounded",children:(0,m.t)("schedules.copy_confirm","Sao ch\xe9p")})]})]})]})]})]})}let p=(0,d.l)(a,"default"),x=(0,d.l)(a,"getStaticProps"),g=(0,d.l)(a,"getStaticPaths"),b=(0,d.l)(a,"getServerSideProps"),y=(0,d.l)(a,"config"),f=(0,d.l)(a,"reportWebVitals"),j=(0,d.l)(a,"unstable_getStaticProps"),w=(0,d.l)(a,"unstable_getStaticPaths"),N=(0,d.l)(a,"unstable_getStaticParams"),k=(0,d.l)(a,"unstable_getServerProps"),S=(0,d.l)(a,"unstable_getServerSideProps"),_=new l.PagesRouteModule({definition:{kind:r.x.PAGES,page:"/schedules",pathname:"/schedules",bundlePath:"",filename:""},components:{App:n.default,Document:c()},userland:a})},2785:e=>{e.exports=require("next/dist/compiled/next-server/pages.runtime.prod.js")},6689:e=>{e.exports=require("react")},6405:e=>{e.exports=require("react-dom")},997:e=>{e.exports=require("react/jsx-runtime")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")},9796:e=>{e.exports=require("zlib")}};var t=require("../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[761,199,209,450,181],()=>__webpack_exec__(4776));module.exports=s})();